<!DOCTYPE html><html lang="zh-CN" color-mode="light"><head><link href="https://fastly.jsdelivr.net/npm/hexo-tag-common@0.2.0/css/index.css" rel="stylesheet"><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><script defer src="/_vercel/insights/script.js"></script><script defer src="/_vercel/speed-insights/script.js"></script><meta name="author" content="yxcheng"><title>CMPXCHG 指令与 CAS | 躺着好舒服</title><link rel="apple-touch-icon" href="/images/favicon.png"><link rel="icon" href="/images/favicon.png"><link href="https://fonts.googleapis.com/css?family=Raleway&display=swap" rel="stylesheet"><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_1886449_67xjft27j1l.css"><link rel="stylesheet" href="/css/figcaption/mac-block.css"><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-3163875893588085" crossorigin="anonymous"></script><script defer type="text/javascript" src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><link href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css" rel="stylesheet"><script defer type="text/javascript" src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js"></script><script src="/js/fancybox.js"></script><script async src="https://www.googletagmanager.com/gtag/js?id=G-WB9L6JQGS1"></script><script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-WB9L6JQGS1")</script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script>var html=document.documentElement;const colorMode=localStorage.getItem("color-mode");colorMode&&document.documentElement.setAttribute("color-mode",colorMode)</script><link rel="stylesheet" href="/css/collapse-code.css"><script src="/js/collapse-code.js"></script><meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="躺着好舒服" type="application/atom+xml"></head><body><div id="app"><div class="header"><div class="avatar"><a href="/"><img no-lazy src="/images/avatar.png" alt=""></a><div class="nickname"><a href="/">躺着好舒服</a></div></div><div class="navbar"><ul><li class="nav-item" data-path="/"><a href="/">首页</a></li><li class="nav-item" data-path="/tags/"><a href="/tags/">标签</a></li><li class="nav-item" data-path="/categories/"><a href="/categories/">分类</a></li><li class="nav-item" data-path="/archives/"><a href="/archives/">归档</a></li><li class="nav-item" data-path="/notes/"><a href="/notes/">Notes</a></li><li class="nav-item" data-path="/adventure/"><a href="/adventure/">冒险乐园</a></li></ul></div></div><script src="/js/activeNav.js"></script><div class="flex-container"><script async type="text/javascript" src="https://cdn.jsdelivr.net/npm/clipboard@2.0.10/dist/clipboard.min.js"></script><script src="/js/codeCopy.js"></script><div class="container post-details" id="post-details"><div class="post-content"><div class="post-title">CMPXCHG 指令与 CAS</div><div class="post-attach"><span class="post-pubtime"><i class="iconfont icon-updatetime mr-10" title="更新时间"></i> 创建时间:2022-06-23 14:21:27&nbsp; 更新时间:2025-04-21 09:14:59 &nbsp;&nbsp; </span><span><span><i class="iconfont icon-edit"></i> 2k 字 </span>&nbsp;&nbsp; </span><span class="post-tags"><i class="iconfont icon-tags mr-10" title="标签"></i> <span class="span--tag mr-8"><a href="/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/" title="计算机基础">#计算机基础&nbsp;</a></span></span></div><div class="markdown-body"><center><a style="font-style:italic" href="javascript:window.location='https://simba--cheng-cn.translate.goog/' + window.location.pathname + '?_x_tr_sl=zh-CN&amp;_x_tr_tl=en&amp;_x_tr_hl=zh-CN&amp;_x_tr_pto=wapp';">This post is also available in English and alternative languages.</a></center><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/hint.css/2.4.1/hint.min.css"><p>Java中CAS（compare and swap）相关方法，是通过<code>Unsafe</code>中的<code>native</code>方法向下调用底层操作系统，Java语言层面只是对其封装、暴露；</p><p>CAS由CPU层面的指令（CMPXCHG指令）去实现，CAS是实现锁和非阻塞并发数据结构的基础同步原语。</p><p>这里建议先了解CPU缓存和MESI这两个知识点（<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/MESI%E5%8D%8F%E8%AE%AE">MESI协议 - 维基百科</a>、<a href="/posts/40363.html" title="计算机组成原理_CPU缓存">计算机组成原理_CPU缓存</a>）。</p><br><h1 id="结论先行">1. 结论先行</h1><p>CAS（compare and swap）是CPU层面实现的，在Intel的CPU中由<strong>CMPXCHG</strong>指令来实现；</p><p>多核CPU中，通过将<code>CMPXCHG</code>与<code>LOCK</code>前缀结合起来，实现以<b><font color="#FF4500">原子方式执行比较和交换</font></b>操作。</p><br><h1 id="MESI">2. MESI</h1><blockquote><p>先炒炒冷饭，回顾下MESI。</p></blockquote><p>现代CPU中有多个core，每个core都有自己的L1、L2缓存，那就会遇到缓存一致性的问题：<br>同一数据的多个副本可能同时存在于不同core的缓存中。如果允许CPU自由地修改它们自己的副本，就会导致不同core的缓存对存储器中同一数据的反映不一致。</p><p>现代计算机、操作系统通过<strong>MESI协议</strong>来确保缓存一致性。</p><p>MESI是<code>cache line（缓存行）</code>的四种状态：<code>Modified(已修改)</code>、<code>Exclusive(独占)</code>、<code>Shared(共享)</code>、<code>Invalid(失效)</code> ；多核系统中，缓存行都处于这四种状态之一。</p><ul><li><p>独占（Exclusive）缓存行<br>和主存保持一致，并且缓存行只在一个core中（其他core不能同时持有它）；<br>当别的core要读取它时，状态变为<code>共享</code>；当core写（修改）后，状态变为<code>已修改（Modified）</code>。</p><blockquote><p>在<code>独占（Exclusive）</code>状态下的缓存行，如果收到来自总线的读取请求，这个缓存行就会变成<code>共享（Shared）</code>状态。这个共享状态是因为，另一个core也把对应的缓存行从内存中加载到了自己的缓存中。</p></blockquote><p></p></li><li><p>已修改（Modified）缓存行<br>缓存行中数据与主存中的数据不同，被所属的core修改；如果别的CPU内核要读主存这块数据，该缓存行必须回写到主存，状态变为共享。</p><blockquote><p>core的写操作只能在缓存行状态是<code>已修改</code>或<code>独占</code>时可以自由执行（如果没有独占，同一份数据存在于多个core的缓存中，不能直接修改）。</p><p>如果在缓存行是<code>共享</code>状态，core要先发送一条”我要独占”的请求给总线，总线会通知其他所有core（向其他所有的core广播一个请求），要求其他core先把它们对应缓存中的缓存行标识为<code>失效</code>状态（如果它们有的话）；</p><p>这个广播动作叫做<strong>RFO（Request For Ownership）</strong>，即<font color="#FF4500">获取当前对应缓存行数据的所有权</font>。</p><p>只有获得独占权后，core才能开始修改数据，并且此时core知道，这个缓存行只有一份拷贝，就在自己的缓存中，core写完以后，将状态置为<code>已修改</code>。</p><p>上面说过，core会一直嗅探总线，监听读写请求。</p><p>对于<code>已修改</code>状态的缓存行，如果别的core要读主存这块数据，该缓存行必须插入总线、回写到主存，状态变为<code>共享</code>。</p></blockquote><p></p></li><li><p>失效（Invalid）缓存行<br>这种状态的缓存行会被忽略； 一旦缓存行被标识为’失效’，那对于CPU来说，等同于它从来没被加载到缓存中。</p><p></p></li><li><p>共享（Shared）缓存行<br>和主存数据保持一致的拷贝，这种状态下的缓存行可以在任意时刻抛弃。</p><blockquote><p>上面说过，core会一直嗅探总线，监听读写请求。</p><p>对于共享状态的缓存行，如果其他core有<code>独占</code>广播，并且命中，则会将该缓存行状态置为<code>失效</code>状态</p></blockquote></li></ul><br><h1 id="CAS">3. CAS</h1><p>几乎现代所有CPU指令都支持CAS原子操作，在Intel#x86的CPU架构中，通过<code>cmpxchg</code>指令集完成CAS（compare and swap）功能；如果CPU是多核，必须添加<strong>lock</strong>前缀；</p><blockquote><p>截止2013年，大多数处理器架构在硬件上都支持CAS，<strong>CAS（compare and swap）</strong>是实现锁和非阻塞并发数据结构的基础同步原语。<br>—- <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Compare-and-swap">Compare-and-swap - Wikipedia</a></p></blockquote><p>CAS操作包含三个操作数：内存位置、预期值、新值。</p><p>CAS的实现逻辑是：将内存位置处的数值与预期值进行比较，如果相等，则将内存位置处的值替换为新值；或不等，则不做任何操作。</p><p>需要注意的是，CAS的实现原理依赖于<code>MESI</code>协议，直白的说：多个Core同时执行针对同一地址的CAS指令时，其实它们是在试图修改（独占）Core持有的<code>cache line（缓存行）</code>。</p><p>假设两个Core（A#Core和B#Core）都持有相同地址对应的<code>cache line（缓存行）</code>，并且它们各自的状态都是<code>Shared（共享）</code>；</p><p>如果此时A#Core想要成功修改，首先要把缓存行的状态由<code>Shared（共享）</code>改为<code>Exclusive（独占）</code>。</p><blockquote><p>即：A#Core向总线广播<code>Exclusive（独占）</code>状态请求，<strong>获取当前对应缓存行数据的所有权</strong>，B#Core嗅探到<code>Exclusive（独占）</code>请求，会将自己Core所属的<code>cache line（缓存行）</code>状态设置为<code>失效（Invalid）</code>；</p></blockquote><p>但如果此时A#Core和B#Core同时向总线广播<code>Exclusive（独占）</code>状态请求，那就会触发<strong>总线仲裁</strong>，看A#Core和B#Core谁能获胜，获胜者就能获取<code>cache line（缓存行）</code>的独占；失败者则将自己Core所属的<code>cache line（缓存行）</code>状态设置为<code>失效（Invalid）</code>；</p><blockquote><p>以上分析，基于<code>cache line</code>（缓存行）对齐的情况下，如果<code>cache line（缓存行）</code>没有对齐，则会触发<code>lock bus（总线锁）</code>。</p><pre><code>--- 《Intel64 and IA32 Architectures Software Developer’s Manual》（Chapter 8.1.4 Effects of a LOCK Operation on Internal Processor Caches）
</code></pre></blockquote><br><h2 id="CMPXCHG指令">3.1. CMPXCHG指令</h2><p><b><font color="#FF4500">CMPXCHG（比较与交换）</font></b> 和 <strong>CMPXCHG8B(比较与交换 8bytes)</strong> 指令在多处理器系统中用于同步操作。</p><p><code>CMPXCHG</code>指令需要三个操作数：寄存器中的一个源操作数、EAX寄存器中的另一个源操作数和目标操作数。如果目标操作数和EAX寄存器中包含的值相等，则目标操作数将替换为另一个源操作数的值(不在EAX寄存器中的值)。否则，目标操作数的原始值被加载到EAX寄存器中。EFLAGS寄存器中的状态标志反映了从EAX寄存器中的值减去目标操作数所获得的结果。</p><p><code>CMPXCHG</code>指令通常用于测试和修改信号量；它检查信号量是否空闲。</p><p>如果信号量是空闲的，则将其标记为已分配；如果信号量不是空闲的，将获取到当前所有者的ID；这一切都是在一个不间断的操作中完成的；</p><p>在单处理器系统中，<code>CMPXCHG</code>指令在执行多条指令测试和修改信号量之前，不需要切换到保护级别0(禁用中断)。</p><p>对于多处理器系统，可以将<code>CMPXCHG</code>与<code>LOCK</code>前缀结合起来，以<b><font color="#FF4500">原子方式执行比较和交换</font></b>操作。</p><blockquote><p>The CMPXCHG (compare and exchange) and CMPXCHG8B (compare and exchange 8 bytes) instructions are used to synchronize operations in systems that use multiple processors.</p><p>The CMPXCHG instruction requires three operands: a source operand in a register, another source operand in the EAX register, and a destination operand. If the values contained in the destination operand and the EAX register are equal, the destination operand is replaced with the value of the other source operand (the value not in the EAX register). Otherwise, the original value of the destination operand is loaded in the EAX register. The status flags in the EFLAGS register reflect the result that would have been obtained by subtracting the destination operand from the value in the EAX register.</p><hr><p>The CMPXCHG instruction is commonly used for testing and modifying semaphores. It checks to see if a semaphore is free.</p><p>If the semaphore is free, it is marked allocated; otherwise it gets the ID of the current owner. This is all done in one uninterruptible operation.</p><p>In a single-processor system, the CMPXCHG instruction eliminates the need to switch to protection level 0 (to disable interrupts) before executing multiple instructions to test and modify a semaphore.</p><p>For multiple processor systems, CMPXCHG can be combined with the LOCK prefix to perform the compare and exchange operation atomically.</p></blockquote><br><h1 id="Reference">4. Reference</h1><ul><li>《Intel64 and IA32 Architectures Software Developer’s Manual》</li><li><a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Compare-and-swap">Compare-and-swap - Wikipedia</a></li><li><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/24146167">浅论Lock 与X86 Cache 一致性</a></li></ul><br><link rel="stylesheet" href="/css/folder.css" type="text/css"><script src="/js/folder.js" type="text/javascript" async></script><link rel="stylesheet" href="/css/spoiler.css" type="text/css"><script src="/js/spoiler.js" type="text/javascript" async></script></div></div><div id="btn-catalog" class="btn-catalog"><i class="iconfont icon-catalog"></i></div><div class="post-catalog hidden" id="catalog"><div class="title">目录</div><div class="catalog-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%BB%93%E8%AE%BA%E5%85%88%E8%A1%8C"><span class="toc-text">1. 结论先行</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#MESI"><span class="toc-text">2. MESI</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#CAS"><span class="toc-text">3. CAS</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#CMPXCHG%E6%8C%87%E4%BB%A4"><span class="toc-text">3.1. CMPXCHG指令</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Reference"><span class="toc-text">4. Reference</span></a></li></ol></div></div><script src="/js/catalog.js"></script><div class="comments-container"></div></div><div class="footer"><div class="social"><ul><li><a title="github" target="_blank" rel="noopener" href="https://github.com/Simba-cheng"><i class="iconfont icon-github"></i></a></li><li><a title="rss" href="/atom.xml"><i class="iconfont icon-rss"></i></a></li></ul></div><div class="footer-more"><a target="_blank" rel="noopener" href="https://github.com/zchengsite/hexo-theme-oranges">Copyright © 2025 Oranges</a></div><div class="footer-more"><a target="_blank" rel="noopener" href="https://github.com/zchengsite/hexo-theme-oranges">Theme by Oranges | Powered by Hexo</a></div><div class="footer-views">本站总访问量<span id="busuanzi_value_site_pv"></span>次 本文总阅读量<span id="busuanzi_value_page_pv"></span>次 本站访客数<span id="busuanzi_value_site_uv"></span>人</div></div></div><div class="tools-bar"><div class="back-to-top tools-bar-item hidden"><a href="javascript: void(0)"><i class="iconfont icon-chevronup"></i></a></div><script src="/js/backtotop.js"></script><div class="search-icon tools-bar-item" id="search-icon"><a href="javascript: void(0)"><i class="iconfont icon-search"></i></a></div><div class="search-overlay hidden"><div class="search-content" tabindex="0"><div class="search-title"><span class="search-icon-input"><a href="javascript: void(0)"><i class="iconfont icon-search"></i> </a></span><input type="text" class="search-input" id="search-input" placeholder="搜索..."> <span class="search-close-icon" id="search-close-icon"><a href="javascript: void(0)"><i class="iconfont icon-close"></i></a></span></div><div class="search-result" id="search-result"></div></div></div><script type="text/javascript">var inputArea=document.querySelector("#search-input"),searchOverlayArea=document.querySelector(".search-overlay");function openOrHideSearchContent(){searchOverlayArea.classList.contains("hidden")?(searchOverlayArea.classList.remove("hidden"),document.body.classList.add("hidden")):(searchOverlayArea.classList.add("hidden"),document.body.classList.remove("hidden"))}function blurSearchContent(e){e.target===searchOverlayArea&&openOrHideSearchContent()}inputArea.onclick=function(){getSearchFile(),this.onclick=null},inputArea.onkeydown=function(){if(13==event.keyCode)return!1},document.querySelector("#search-icon").addEventListener("click",openOrHideSearchContent,!1),document.querySelector("#search-close-icon").addEventListener("click",openOrHideSearchContent,!1),searchOverlayArea.addEventListener("click",blurSearchContent,!1);var searchFunc=function(e,t,n){"use strict";var r=document.getElementById(t),a=document.getElementById(n);a.innerHTML="<ul><span class='local-search-empty'>首次搜索，正在载入索引文件，请稍后……<span></ul>",$.ajax({url:e,dataType:"xml",success:function(e){var t=$("entry",e).map(function(){return{title:$("title",this).text(),content:$("content",this).text(),url:$("url",this).text()}}).get();a.innerHTML="",r.addEventListener("input",function(){var u='<ul class="search-result-list">',h=this.value.trim().toLowerCase().split(/[\s\-]+/);if(a.innerHTML="",!(this.value.trim().length<=0)){if(t.forEach(function(e){var n,r,a=!0,t=(e.title&&""!==e.title.trim()||(e.title="Untitled"),e.title.trim()),c=t.toLowerCase(),s=e.content.trim().replace(/<[^>]+>/g,""),i=s.toLowerCase(),e=e.url,l=-1,o=-1;""!==i?h.forEach(function(e,t){n=c.indexOf(e),l=i.indexOf(e),n<0&&l<0?a=!1:(l<0&&(l=0),0==t&&(o=l))}):a=!1,a&&(u+="<li><a href='"+e+"' class='search-result-title'>"+t+"</a>",0<=o&&(e=o+80,(e=0==(t=(t=o-20)<0?0:t)?100:e)>s.length&&(e=s.length),r=s.substr(t,e),h.forEach(function(e){var t=new RegExp(e,"gi");r=r.replace(t,'<span class="search-keyword">'+e+"</span>")}),u+='<p class="search-result-abstract">'+r+"...</p>"),u+="</li>")}),-1===(u+="</ul>").indexOf("<li>"))return a.innerHTML="<ul><span class='local-search-empty'>没有找到内容，请尝试更换检索词。<span></ul>";a.innerHTML=u}})},error:function(e,t,n){a.innerHTML="",404===e.status?a.innerHTML="<ul><span class='local-search-empty'>未找到search.xml文件，具体请参考：<a href='https://github.com/zchengsite/hexo-theme-oranges#configuration' target='_black'>configuration</a><span></ul>":a.innerHTML="<ul><span class='local-search-empty'>请求失败，尝试重新刷新页面或稍后重试。<span></ul>"}}),$(document).on("click","#search-close-icon",function(){$("#search-input").val(""),$("#search-result").html("")})},getSearchFile=function(){searchFunc("/search.xml","search-input","search-result")}</script><div class="tools-bar-item theme-icon" id="switch-color-scheme"><a href="javascript: void(0)"><i id="theme-icon" class="iconfont icon-moon"></i></a></div><script src="/js/colorscheme.js"></script><div class="share-icon tools-bar-item"><a href="javascript: void(0)" id="share-icon"><i class="iconfont iconshare"></i></a><div class="share-content hidden"><a class="share-item" href="https://twitter.com/intent/tweet?text=' + CMPXCHG%20%E6%8C%87%E4%BB%A4%E4%B8%8E%20CAS + '&url=' + https%3A%2F%2Fsimba-cheng.github.io%2Fposts%2F54412.html + '" target="_blank" title="Twitter"><i class="iconfont icon-twitter"></i> </a><a class="share-item" href="https://www.facebook.com/sharer.php?u=https://simba-cheng.github.io/posts/54412.html" target="_blank" title="Facebook"><i class="iconfont icon-facebooksquare"></i></a></div></div><script src="/js/shares.js"></script></div></div><script src="https://fastly.jsdelivr.net/npm/hexo-tag-common@0.2.0/js/index.js"></script><style>[bg-lazy]{background-image:none!important;background-color:#eee!important}</style><script>window.imageLazyLoadSetting={isSPA:!1,preloadRatio:3,processImages:null}</script><script>window.addEventListener("load",function(){var t=/\.(gif|jpg|jpeg|tiff|png)$/i,r=/^data:image\/[a-z]+;base64,/;Array.prototype.slice.call(document.querySelectorAll("img[data-original]")).forEach(function(a){var e=a.parentNode;"A"===e.tagName&&(e.href.match(t)||e.href.match(r))&&(e.href=a.dataset.original)})})</script><script>!function(r){r.imageLazyLoadSetting.processImages=t;var e=r.imageLazyLoadSetting.isSPA,n=r.imageLazyLoadSetting.preloadRatio||1,c=a();function a(){var t=Array.prototype.slice.call(document.querySelectorAll("img[data-original]")),e=Array.prototype.slice.call(document.querySelectorAll("[bg-lazy]"));return t.concat(e)}function t(){e&&(c=a());for(var t,o=0;o<c.length;o++)0<=(t=(t=c[o]).getBoundingClientRect()).bottom&&0<=t.left&&t.top<=(r.innerHeight*n||document.documentElement.clientHeight*n)&&function(){var t,e,n,a=c[o],i=function(){c=c.filter(function(t){return a!==t}),r.imageLazyLoadSetting.onImageLoaded&&r.imageLazyLoadSetting.onImageLoaded(a)};(t=a).hasAttribute("bg-lazy")?(t.removeAttribute("bg-lazy"),i()):(e=new Image,n=t.getAttribute("data-original"),e.onload=function(){t.src=n,t.removeAttribute("data-original"),i()},t.src!==n&&(e.src=n))}()}function i(){clearTimeout(t.tId),t.tId=setTimeout(t,500)}t(),document.addEventListener("scroll",i),r.addEventListener("resize",i),r.addEventListener("orientationchange",i)}(this)</script><script src="/js/markmap.js"></script></body></html>