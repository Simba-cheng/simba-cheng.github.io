<!DOCTYPE html><html lang="zh-CN" color-mode="light"><head><link href="https://fastly.jsdelivr.net/npm/hexo-tag-common@0.2.0/css/index.css" rel="stylesheet"><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><script defer src="/_vercel/insights/script.js"></script><script defer src="/_vercel/speed-insights/script.js"></script><meta name="author" content="yxcheng"><title>Future 和 CompletableFuture | 躺着好舒服</title><link rel="apple-touch-icon" href="/images/favicon.png"><link rel="icon" href="/images/favicon.png"><link href="https://fonts.googleapis.com/css?family=Raleway&display=swap" rel="stylesheet"><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_1886449_67xjft27j1l.css"><link rel="stylesheet" href="/css/figcaption/mac-block.css"><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-3163875893588085" crossorigin="anonymous"></script><script defer type="text/javascript" src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><link href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css" rel="stylesheet"><script defer type="text/javascript" src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js"></script><script src="/js/fancybox.js"></script><script async src="https://www.googletagmanager.com/gtag/js?id=G-WB9L6JQGS1"></script><script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-WB9L6JQGS1")</script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script>var html=document.documentElement;const colorMode=localStorage.getItem("color-mode");colorMode&&document.documentElement.setAttribute("color-mode",colorMode)</script><link rel="stylesheet" href="/css/collapse-code.css"><script src="/js/collapse-code.js"></script><meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="躺着好舒服" type="application/atom+xml"></head><body><div id="app"><div class="header"><div class="avatar"><a href="/"><img no-lazy src="/images/avatar.png" alt=""></a><div class="nickname"><a href="/">躺着好舒服</a></div></div><div class="navbar"><ul><li class="nav-item" data-path="/"><a href="/">首页</a></li><li class="nav-item" data-path="/tags/"><a href="/tags/">标签</a></li><li class="nav-item" data-path="/categories/"><a href="/categories/">分类</a></li><li class="nav-item" data-path="/archives/"><a href="/archives/">归档</a></li><li class="nav-item" data-path="/notes/"><a href="/notes/">Notes</a></li><li class="nav-item" data-path="/adventure/"><a href="/adventure/">冒险乐园</a></li></ul></div></div><script src="/js/activeNav.js"></script><div class="flex-container"><script async type="text/javascript" src="https://cdn.jsdelivr.net/npm/clipboard@2.0.10/dist/clipboard.min.js"></script><script src="/js/codeCopy.js"></script><div class="container post-details" id="post-details"><div class="post-content"><div class="post-title">Future 和 CompletableFuture</div><div class="post-attach"><span class="post-pubtime"><i class="iconfont icon-updatetime mr-10" title="更新时间"></i> 创建时间:2021-09-10 10:08:33&nbsp; 更新时间:2025-04-21 09:14:58 &nbsp;&nbsp; </span><span><span><i class="iconfont icon-edit"></i> 7.3k 字 </span>&nbsp;&nbsp; </span><span class="post-tags"><i class="iconfont icon-tags mr-10" title="标签"></i> <span class="span--tag mr-8"><a href="/tags/%E5%B9%B6%E5%8F%91/" title="并发">#并发&nbsp;</a></span></span></div><div class="markdown-body"><center><a style="font-style:italic" href="javascript:window.location='https://simba--cheng-cn.translate.goog/' + window.location.pathname + '?_x_tr_sl=zh-CN&amp;_x_tr_tl=en&amp;_x_tr_hl=zh-CN&amp;_x_tr_pto=wapp';">This post is also available in English and alternative languages.</a></center><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/hint.css/2.4.1/hint.min.css"><br><h1 id="普通Future">1. 普通Future</h1><p>普通线程的创建方式有两种，<strong>①继承Thread类</strong>，<strong>②实现Runnable接口</strong>。</p><p>这两种方式创建的线程，在运行结束后，都无法直接获取结果。</p><p>Java 5.0 引入 Callable 和 Future，通过它们创建的线程，在运行结束后可以通过 get()方法 获取结果。</p><p>下面两个示例，通过 Callable 创建线程，提交到线程池中运行，然后获得 Future 对象，通过 Future .get() 获取运行结果。</p><br><h2 id="get-方法示例">1.1. get() 方法示例</h2><p>get()方法是阻塞方法，一直到线程运行完毕(抛出异常)才能返回结果。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FutureMainApp01</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Logger</span> <span class="variable">LOGGER</span> <span class="operator">=</span> LoggerFactory.getLogger(FutureMainApp01.class);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">ThreadPoolExecutor</span> <span class="variable">threadPoolExecutor</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ThreadPoolExecutor</span>(</span><br><span class="line">            <span class="number">16</span>, <span class="number">32</span>, <span class="number">30</span>,</span><br><span class="line">            TimeUnit.SECONDS,</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">ArrayBlockingQueue</span>&lt;&gt;(<span class="number">512</span>),</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">ThreadPoolExecutor</span>.AbortPolicy());</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">FutureMainApp01</span> <span class="variable">futureMainApp01</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FutureMainApp01</span>();</span><br><span class="line">        futureMainApp01.process();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">process</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">ShardedJedisOperate</span> <span class="variable">shardedJedisOperate</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ShardedJedisOperate</span>();</span><br><span class="line">            <span class="type">AnalysisData</span> <span class="variable">analysisData</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AnalysisData</span>(shardedJedisOperate, <span class="string">&quot;1-key&quot;</span>, <span class="string">&quot;1-value&quot;</span>);</span><br><span class="line">            Future&lt;String&gt; future = threadPoolExecutor.submit(analysisData);</span><br><span class="line">            <span class="comment">//String result = future.get();</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">result</span> <span class="operator">=</span> future.get(<span class="number">300</span>,TimeUnit.MILLISECONDS);</span><br><span class="line">            LOGGER.info(<span class="string">&quot;result:&#123;&#125;&quot;</span>, result);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            LOGGER.error(e.getMessage(), e);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            threadPoolExecutor.shutdown();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">AnalysisData</span> <span class="keyword">implements</span> <span class="title class_">Callable</span>&lt;String&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Logger</span> <span class="variable">LOGGER</span> <span class="operator">=</span> LoggerFactory.getLogger(AnalysisData.class);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> ShardedJedisOperate shardedJedisOperate;</span><br><span class="line">    <span class="keyword">private</span> String key;</span><br><span class="line">    <span class="keyword">private</span> String value;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">AnalysisData</span><span class="params">(ShardedJedisOperate shardedJedisOperate, String key, String value)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.shardedJedisOperate = shardedJedisOperate;</span><br><span class="line">        <span class="built_in">this</span>.key = key;</span><br><span class="line">        <span class="built_in">this</span>.value = value;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">call</span><span class="params">()</span> &#123;</span><br><span class="line">        LOGGER.info(<span class="string">&quot;set redis info key:&#123;&#125;,val:&#123;&#125;&quot;</span>, key, value);</span><br><span class="line">        <span class="keyword">return</span> shardedJedisOperate.set(key, value);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><br><h2 id="get-timeout-timeUnit-方法示例">1.2. get(timeout, timeUnit) 方法示例</h2><p>该方法可以设定时间，在指定时间内没有获取到结果，则直接返回null。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FutureMainApp01</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Logger</span> <span class="variable">LOGGER</span> <span class="operator">=</span> LoggerFactory.getLogger(FutureMainApp01.class);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">ThreadPoolExecutor</span> <span class="variable">threadPoolExecutor</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ThreadPoolExecutor</span>(</span><br><span class="line">            <span class="number">16</span>, <span class="number">32</span>, <span class="number">30</span>,</span><br><span class="line">            TimeUnit.SECONDS,</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">ArrayBlockingQueue</span>&lt;&gt;(<span class="number">512</span>),</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">ThreadPoolExecutor</span>.AbortPolicy());</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">FutureMainApp01</span> <span class="variable">futureMainApp01</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FutureMainApp01</span>();</span><br><span class="line">        futureMainApp01.process();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">process</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">ShardedJedisOperate</span> <span class="variable">shardedJedisOperate</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ShardedJedisOperate</span>();</span><br><span class="line">            <span class="type">AnalysisData</span> <span class="variable">analysisData</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AnalysisData</span>(shardedJedisOperate, <span class="string">&quot;1-key&quot;</span>, <span class="string">&quot;1-value&quot;</span>);</span><br><span class="line">            Future&lt;String&gt; future = threadPoolExecutor.submit(analysisData);</span><br><span class="line">            <span class="type">String</span> <span class="variable">result</span> <span class="operator">=</span> future.get(<span class="number">300</span>,TimeUnit.MILLISECONDS);</span><br><span class="line">            LOGGER.info(<span class="string">&quot;result:&#123;&#125;&quot;</span>, result);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            LOGGER.error(e.getMessage(), e);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            threadPoolExecutor.shutdown();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">AnalysisData</span> <span class="keyword">implements</span> <span class="title class_">Callable</span>&lt;String&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Logger</span> <span class="variable">LOGGER</span> <span class="operator">=</span> LoggerFactory.getLogger(AnalysisData.class);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> ShardedJedisOperate shardedJedisOperate;</span><br><span class="line">    <span class="keyword">private</span> String key;</span><br><span class="line">    <span class="keyword">private</span> String value;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">AnalysisData</span><span class="params">(ShardedJedisOperate shardedJedisOperate, String key, String value)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.shardedJedisOperate = shardedJedisOperate;</span><br><span class="line">        <span class="built_in">this</span>.key = key;</span><br><span class="line">        <span class="built_in">this</span>.value = value;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">call</span><span class="params">()</span> &#123;</span><br><span class="line">        LOGGER.info(<span class="string">&quot;set redis info key:&#123;&#125;,val:&#123;&#125;&quot;</span>, key, value);</span><br><span class="line">        <span class="keyword">return</span> shardedJedisOperate.set(key, value);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Future 还有其他一些方法，比如：</p><ul><li><p><code>isDone()</code> 方法：检查线程是否运行完成。</p></li><li><p><code>cancel()</code> 方法：停止线程的执行。</p></li></ul><br><h2 id="局限性">1.3. 局限性</h2><p>Thread、Runnable 线程的使用，属于异步计算，并不能从线程中得到返回结果。</p><p>Future 线程 可以监视目标线程调用Call()方法，当调用 Future.get()方法以获取结果时，当前线程就开始阻塞，直至call()方法结束返回结果。</p><p>虽然 Future 提供了异步执行任务的能力，但获取结果还是很不方便，只有通过阻塞或轮询得到结果。</p><p>而且，如果要处理多个线程结果很不方便。</p><p>在实际业务中有一个对外接口，要补足商品信息，同时要调用四五个外部接口，之前使用的是普通Future，多个Future结果处理比较麻烦，后来使用 CompletableFuture 进行优化。</p><br><h1 id="CompletableFuture">2. CompletableFuture</h1><p>JDK8 中新增了一个类 CompletableFuture ，对 Future 进行很大的扩展，简化异步编程。</p><br><h2 id="runAsync、supplyAsync">2.1. runAsync、supplyAsync</h2><p>runAsync、supplyAsync 方法是 CompletableFuture 提供的创建异步操作的方法。</p><table><thead><tr><th align="left">方法</th><th>入参</th><th>注意</th></tr></thead><tbody><tr><td align="left">runAsync</td><td>CompletableFuture<void>runAsync(Runnable runnable)<br><br>CompletableFuture<void>runAsync(Runnable runnable,Executor executor)</void></void></td><td>无返回结果</td></tr><tr><td align="left">supplyAsync</td><td>&lt;U&gt; CompletableFuture&lt;U&gt; supplyAsync(Supplier&lt;U&gt; supplier)<br><br>&lt;U&gt; CompletableFuture&lt;U&gt; supplyAsync(Supplier&lt;U&gt; supplier,Executor executor)</td><td>有返回结果</td></tr></tbody></table><p>如果没有指定 线程池，将会使用 <code>ForkJoinPool.commonPool()</code> 作为线程池执行异步代码；如果指定线程池，则使用指定的线程池运行。</p><p>runAsync、supplyAsync 两个方法从使用层面上看，就好像是 Thread &#x2F; Runnable、Callable &#x2F; Future，一个没有结果一个有结果。</p><br><h3 id="runAsync">2.1.1. runAsync</h3><p><code>CompletableFuture.runAsync</code> 只是执行一个异步线程，它不会返回结果，但返回一个 CompletableFuture 对象。</p><p>如果异步操作不需要返回结果，可以使用runAsync。比如需要后台运行一些任务。（也可以使用它进行重新组装和调配？）</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CFutureMainApp01</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Logger</span> <span class="variable">LOGGER</span> <span class="operator">=</span> LoggerFactory.getLogger(CFutureMainApp01.class);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">ShardedJedisOperate</span> <span class="variable">shardedJedisOperate</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ShardedJedisOperate</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">ThreadPoolExecutor</span> <span class="variable">threadPoolExecutor</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ThreadPoolExecutor</span>(</span><br><span class="line">            <span class="number">16</span>, <span class="number">32</span>, <span class="number">30</span>,</span><br><span class="line">            TimeUnit.SECONDS,</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">ArrayBlockingQueue</span>&lt;&gt;(<span class="number">512</span>),</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">ThreadPoolExecutor</span>.AbortPolicy());</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> ExecutionException, InterruptedException &#123;</span><br><span class="line">        <span class="type">CFutureMainApp01</span> <span class="variable">cFutureMainApp01</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CFutureMainApp01</span>();</span><br><span class="line">        cFutureMainApp01.testRunAsync();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">testRunAsync</span><span class="params">()</span> <span class="keyword">throws</span> ExecutionException, InterruptedException &#123;</span><br><span class="line">        CompletableFuture&lt;Void&gt; voidCompletableFuture = CompletableFuture.runAsync(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                TimeUnit.MILLISECONDS.sleep(<span class="number">1000</span>);</span><br><span class="line">                <span class="type">String</span> <span class="variable">result</span> <span class="operator">=</span> shardedJedisOperate.set(<span class="string">&quot;2-key&quot;</span>, <span class="string">&quot;2-value&quot;</span>);</span><br><span class="line">                LOGGER.info(<span class="string">&quot;result:&#123;&#125;&quot;</span>, result);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                LOGGER.error(e.getMessage(), e);</span><br><span class="line">            &#125;</span><br><span class="line">            LOGGER.info(<span class="string">&quot;....end....&quot;</span>);</span><br><span class="line">        &#125;, threadPoolExecutor);</span><br><span class="line">        voidCompletableFuture.get();</span><br><span class="line">        threadPoolExecutor.shutdown();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br><h3 id="supplyAsync">2.1.2. supplyAsync</h3><p>CompletableFuture.supplyAsync 执行异步线程 并 返回计算结果。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">testSupplyAsync</span><span class="params">()</span> <span class="keyword">throws</span> ExecutionException, InterruptedException &#123;</span><br><span class="line">    CompletableFuture&lt;String&gt; completableFuture = CompletableFuture.supplyAsync(<span class="keyword">new</span> <span class="title class_">Supplier</span>&lt;String&gt;() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> String <span class="title function_">get</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">result</span> <span class="operator">=</span> StringUtils.EMPTY;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                TimeUnit.MILLISECONDS.sleep(<span class="number">1000</span>);</span><br><span class="line">                result = shardedJedisOperate.set(<span class="string">&quot;3-key&quot;</span>, <span class="string">&quot;3-value&quot;</span>);</span><br><span class="line">                LOGGER.info(<span class="string">&quot;result:&#123;&#125;&quot;</span>, result);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                LOGGER.error(e.getMessage(), e);</span><br><span class="line">            &#125;</span><br><span class="line">            LOGGER.info(<span class="string">&quot;....end....&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> result;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;, threadPoolExecutor);</span><br><span class="line">    <span class="type">String</span> <span class="variable">result</span> <span class="operator">=</span> completableFuture.get();</span><br><span class="line">    LOGGER.info(<span class="string">&quot;end result:&#123;&#125;&quot;</span>, result);</span><br><span class="line">    threadPoolExecutor.shutdown();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br><h2 id="whenComplete、exceptionally">2.2. whenComplete、exceptionally</h2><p>三个方法 whenComplete、whenCompleteAsync、exceptionally 都是 CompletableFuture 运行完成 或 抛出异常 后继续执行的方法(任务)，相当一个后置处理。</p><table><thead><tr><th>方法</th><th>入参</th><th>注意</th></tr></thead><tbody><tr><td>whenComplete</td><td>whenComplete(BiConsumer&lt;? super T, ? super Throwable&gt; action)</td><td><strong>任务运行完成后，当前任务的线程继续执行 whenComplete 任务。</strong><br><br>任务运行 成功&#x2F;失败 都会执行 whenComplete。</td></tr><tr><td>whenCompleteAsync</td><td>whenCompleteAsync(BiConsumer&lt;? super T, ? super Throwable&gt; action)<br><br>whenCompleteAsync(BiConsumer&lt;? super T, ? super Throwable&gt; action, Executor executor)</td><td><strong>任务运行完成后，whenCompleteAsync任务 提交给线程池进行处理。</strong><br><br>任务运行 成功&#x2F;失败 都会执行 whenCompleteAsync。</td></tr><tr><td>exceptionally</td><td>exceptionally(Function&lt;Throwable, ? extends T&gt; fn)</td><td><strong>只有当 CompletableFuture 抛出异常的时候，才会触发 exceptionally 任务。</strong><br><br>只有任务运行失败，才会执行。</td></tr></tbody></table><br><h3 id="whenComplete">2.2.1. whenComplete</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">testWhenComplete</span><span class="params">()</span> <span class="keyword">throws</span> ExecutionException, InterruptedException &#123;</span><br><span class="line">    CompletableFuture&lt;String&gt; completableFuture = CompletableFuture.supplyAsync(() -&gt; &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">result</span> <span class="operator">=</span> StringUtils.EMPTY;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            TimeUnit.MILLISECONDS.sleep(<span class="number">1000</span>);</span><br><span class="line">            result = shardedJedisOperate.set(<span class="string">&quot;4-key&quot;</span>, <span class="string">&quot;4-value&quot;</span>);</span><br><span class="line">            LOGGER.info(<span class="string">&quot;result:&#123;&#125;&quot;</span>, result);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            LOGGER.error(e.getMessage(), e);</span><br><span class="line">        &#125;</span><br><span class="line">        LOGGER.info(<span class="string">&quot;....end....&quot;</span>);</span><br><span class="line">        <span class="comment">//模拟异常</span></span><br><span class="line">        <span class="comment">//String[] a = new String[2];</span></span><br><span class="line">        <span class="comment">//LOGGER.info(&quot;index:&#123;&#125;&quot;, a[100]);</span></span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;, threadPoolExecutor);</span><br><span class="line"></span><br><span class="line">    CompletableFuture&lt;String&gt; whenComplete = completableFuture.whenComplete(<span class="keyword">new</span> <span class="title class_">BiConsumer</span>&lt;String, Throwable&gt;() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">accept</span><span class="params">(String s, Throwable throwable)</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (Objects.nonNull(throwable)) &#123;</span><br><span class="line">                LOGGER.error(<span class="string">&quot;error message:&#123;&#125;&quot;</span>, throwable.getMessage(), throwable);</span><br><span class="line">            &#125;</span><br><span class="line">            LOGGER.warn(<span class="string">&quot;运行结束，关闭资源&quot;</span>);</span><br><span class="line">            threadPoolExecutor.shutdown();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    LOGGER.info(<span class="string">&quot;end result:&#123;&#125;&quot;</span>, whenComplete.get());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>运行结果：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[pool-<span class="number">1</span>-thread-<span class="number">1</span>] INFO  org.future.two.CFutureMainApp02 - <span class="number">83</span> - result:OK</span><br><span class="line">[pool-<span class="number">1</span>-thread-<span class="number">1</span>] INFO  org.future.two.CFutureMainApp02 - <span class="number">87</span> - ....end....</span><br><span class="line">[pool-<span class="number">1</span>-thread-<span class="number">1</span>] WARN  org.future.two.CFutureMainApp02 - <span class="number">102</span> - 运行结束，关闭资源</span><br><span class="line">[main] INFO  org.future.two.CFutureMainApp02 - <span class="number">106</span> - end result:OK</span><br></pre></td></tr></table></figure><p>输出结果中，最后 102 行日志打印的线程号，和上面的线程号是一样的。</p><p>任务执行完以后，当前任务线程继续执行 whenComplete 任务。</p><br><h3 id="whenCompleteAsync">2.2.2. whenCompleteAsync</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">testWhenCompleteAsync</span><span class="params">()</span> <span class="keyword">throws</span> ExecutionException, InterruptedException &#123;</span><br><span class="line">    CompletableFuture&lt;String&gt; completableFuture = CompletableFuture.supplyAsync(() -&gt; &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">result</span> <span class="operator">=</span> StringUtils.EMPTY;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            TimeUnit.MILLISECONDS.sleep(<span class="number">1000</span>);</span><br><span class="line">            result = shardedJedisOperate.set(<span class="string">&quot;5-key&quot;</span>, <span class="string">&quot;5-value&quot;</span>);</span><br><span class="line">            LOGGER.info(<span class="string">&quot;result:&#123;&#125;&quot;</span>, result);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            LOGGER.error(e.getMessage(), e);</span><br><span class="line">        &#125;</span><br><span class="line">        LOGGER.info(<span class="string">&quot;....end....&quot;</span>);</span><br><span class="line">        <span class="comment">//模拟异常</span></span><br><span class="line">        <span class="comment">//String[] a = new String[2];</span></span><br><span class="line">        <span class="comment">//LOGGER.info(&quot;index:&#123;&#125;&quot;, a[100]);</span></span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;, threadPoolExecutor);</span><br><span class="line"></span><br><span class="line">    CompletableFuture&lt;String&gt; whenCompleteAsync = completableFuture.whenCompleteAsync(<span class="keyword">new</span> <span class="title class_">BiConsumer</span>&lt;String, Throwable&gt;() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">accept</span><span class="params">(String s, Throwable throwable)</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (Objects.nonNull(throwable)) &#123;</span><br><span class="line">                LOGGER.error(<span class="string">&quot;error message:&#123;&#125;&quot;</span>, throwable.getMessage(), throwable);</span><br><span class="line">            &#125;</span><br><span class="line">            LOGGER.warn(<span class="string">&quot;运行结束，关闭资源&quot;</span>);</span><br><span class="line">            threadPoolExecutor.shutdown();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    LOGGER.info(<span class="string">&quot;end result:&#123;&#125;&quot;</span>, whenCompleteAsync.get());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>运行结果：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">default</span> [pool-<span class="number">1</span>-thread-<span class="number">1</span>] INFO  org.future.two.CFutureMainApp02 - <span class="number">116</span> - result:OK</span><br><span class="line"><span class="keyword">default</span> [pool-<span class="number">1</span>-thread-<span class="number">1</span>] INFO  org.future.two.CFutureMainApp02 - <span class="number">120</span> - ....end....</span><br><span class="line"><span class="keyword">default</span> [ForkJoinPool.commonPool-worker-<span class="number">1</span>] WARN  org.future.two.CFutureMainApp02 - <span class="number">133</span> - 运行结束，关闭资源</span><br><span class="line"><span class="keyword">default</span> [main] INFO  org.future.two.CFutureMainApp02 - <span class="number">137</span> - end result:OK</span><br></pre></td></tr></table></figure><p>输出结果中，133 行日志打印的线程号，和上面的线程号不一致，whenCompleteAsync 中的任务 提交给 ForkJoinPool.commonPool() 线程池运行。</p><br><h3 id="exceptionally">2.2.3. exceptionally</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">testExceptionally</span><span class="params">()</span> <span class="keyword">throws</span> ExecutionException, InterruptedException &#123;</span><br><span class="line">    CompletableFuture&lt;String&gt; completableFuture = CompletableFuture.supplyAsync(() -&gt; &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">result</span> <span class="operator">=</span> StringUtils.EMPTY;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            TimeUnit.MILLISECONDS.sleep(<span class="number">1000</span>);</span><br><span class="line">            result = shardedJedisOperate.set(<span class="string">&quot;6-key&quot;</span>, <span class="string">&quot;6-value&quot;</span>);</span><br><span class="line">            LOGGER.info(<span class="string">&quot;result:&#123;&#125;&quot;</span>, result);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            LOGGER.error(e.getMessage(), e);</span><br><span class="line">        &#125;</span><br><span class="line">        LOGGER.info(<span class="string">&quot;....end....&quot;</span>);</span><br><span class="line">        <span class="comment">//模拟异常</span></span><br><span class="line">        <span class="comment">//String[] a = new String[2];</span></span><br><span class="line">        <span class="comment">//LOGGER.info(&quot;index:&#123;&#125;&quot;, a[100]);</span></span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;, threadPoolExecutor);</span><br><span class="line"></span><br><span class="line">    CompletableFuture&lt;String&gt; exceptionally = completableFuture.exceptionally(<span class="keyword">new</span> <span class="title class_">Function</span>&lt;Throwable, String&gt;() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> String <span class="title function_">apply</span><span class="params">(Throwable throwable)</span> &#123;</span><br><span class="line">            LOGGER.error(<span class="string">&quot;error message:&#123;&#125;&quot;</span>, throwable.getMessage(), throwable);</span><br><span class="line">            LOGGER.warn(<span class="string">&quot;运行结束，关闭资源&quot;</span>);</span><br><span class="line">            threadPoolExecutor.shutdown();</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;error&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    LOGGER.info(<span class="string">&quot;end result:&#123;&#125;&quot;</span>, exceptionally.get());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>正常的运行结果</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">default</span> [pool-<span class="number">1</span>-thread-<span class="number">1</span>] INFO  org.future.two.CFutureMainApp02 - <span class="number">147</span> - result:OK</span><br><span class="line"><span class="keyword">default</span> [pool-<span class="number">1</span>-thread-<span class="number">1</span>] INFO  org.future.two.CFutureMainApp02 - <span class="number">151</span> - ....end....</span><br><span class="line"><span class="keyword">default</span> [main] INFO  org.future.two.CFutureMainApp02 - <span class="number">168</span> - end result:OK</span><br></pre></td></tr></table></figure><p>如果运行中发生了异常，exceptionally 任务就会执行。（将模拟异常注释放开）</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">default</span> [pool-<span class="number">1</span>-thread-<span class="number">1</span>] INFO  org.future.two.CFutureMainApp02 - <span class="number">147</span> - result:OK</span><br><span class="line"><span class="keyword">default</span> [pool-<span class="number">1</span>-thread-<span class="number">1</span>] INFO  org.future.two.CFutureMainApp02 - <span class="number">151</span> - ....end....</span><br><span class="line"><span class="keyword">default</span> [pool-<span class="number">1</span>-thread-<span class="number">1</span>] ERROR org.future.two.CFutureMainApp02 - <span class="number">161</span> - error message:java.lang.ArrayIndexOutOfBoundsException: <span class="number">100</span></span><br><span class="line">java.util.concurrent.CompletionException: java.lang.ArrayIndexOutOfBoundsException: <span class="number">100</span></span><br><span class="line">    at java.util.concurrent.CompletableFuture.encodeThrowable(CompletableFuture.java:<span class="number">273</span>)</span><br><span class="line">    at java.util.concurrent.CompletableFuture.completeThrowable(CompletableFuture.java:<span class="number">280</span>)</span><br><span class="line">    at java.util.concurrent.CompletableFuture$AsyncSupply.run(CompletableFuture.java:<span class="number">1592</span>)</span><br><span class="line">    at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:<span class="number">1142</span>)</span><br><span class="line">    at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:<span class="number">617</span>)</span><br><span class="line">    at java.lang.Thread.run(Thread.java:<span class="number">745</span>)</span><br><span class="line">Caused by: java.lang.ArrayIndexOutOfBoundsException: <span class="number">100</span></span><br><span class="line">    at org.future.two.CFutureMainApp02.lambda$testExceptionally$<span class="number">3</span>(CFutureMainApp02.java:<span class="number">154</span>)</span><br><span class="line">    at java.util.concurrent.CompletableFuture$AsyncSupply.run(CompletableFuture.java:<span class="number">1590</span>)</span><br><span class="line">    ... <span class="number">3</span> common frames omitted</span><br><span class="line"><span class="keyword">default</span> [pool-<span class="number">1</span>-thread-<span class="number">1</span>] WARN  org.future.two.CFutureMainApp02 - <span class="number">162</span> - 运行结束，关闭资源</span><br><span class="line"><span class="keyword">default</span> [main] INFO  org.future.two.CFutureMainApp02 - <span class="number">167</span> - end result:error</span><br></pre></td></tr></table></figure><br><h2 id="thenApply、handle">2.3. thenApply、handle</h2><p>当一个线程依赖另一个线程的结果时，或对线程结果进行转换。可以使用 thenApply、handle 两个方法将其串行化。</p><p>当上一个线程运行异常，thenApply方法不会执行，而handle方法则可以处理异常信息。</p><table><thead><tr><th>方法</th><th>入参</th><th>注意</th></tr></thead><tbody><tr><td>thenApply</td><td>thenApply( Function&lt;? super T,? extends U&gt; fn)</td><td></td></tr><tr><td>thenApplyAsync</td><td>thenApplyAsync(Function&lt;? super T,? extends U&gt; fn)<br><br>thenApplyAsync(Function&lt;? super T,? extends U&gt; fn, Executor executor)</td><td>使用ForkJoinPool线程池<br>使用自定义线程池</td></tr><tr><td>handle</td><td>handle(BiFunction&lt;? super T, Throwable, ? extends U&gt; fn)</td><td></td></tr><tr><td>handleAsync</td><td>handleAsync(BiFunction&lt;? super T, Throwable, ? extends U&gt; fn)<br><br>handleAsync(BiFunction&lt;? super T, Throwable, ? extends U&gt; fn, Executor executor)</td><td>使用ForkJoinPool线程池<br>使用自定义线程池</td></tr></tbody></table><br><h3 id="thenApply">2.3.1. thenApply</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">testThenApply</span><span class="params">()</span> <span class="keyword">throws</span> ExecutionException, InterruptedException &#123;</span><br><span class="line">    CompletableFuture&lt;String&gt; supplyAsync = CompletableFuture.supplyAsync(() -&gt; &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">result</span> <span class="operator">=</span> StringUtils.EMPTY;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            TimeUnit.MILLISECONDS.sleep(<span class="number">1000</span>);</span><br><span class="line">            result = shardedJedisOperate.set(<span class="string">&quot;7-key&quot;</span>, <span class="string">&quot;7-value&quot;</span>);</span><br><span class="line">            LOGGER.info(<span class="string">&quot;result-1:&#123;&#125;&quot;</span>, result);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            LOGGER.error(e.getMessage(), e);</span><br><span class="line">        &#125;</span><br><span class="line">        LOGGER.info(<span class="string">&quot;....end-1....&quot;</span>);</span><br><span class="line">        <span class="comment">////模拟异常</span></span><br><span class="line">        <span class="comment">//String[] a = new String[2];</span></span><br><span class="line">        <span class="comment">//LOGGER.info(&quot;index:&#123;&#125;&quot;, a[100]);</span></span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;, threadPoolExecutor);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//test thenApply</span></span><br><span class="line">    <span class="comment">//CompletableFuture&lt;String&gt; completableFuture = supplyAsync.thenApply(s -&gt; &#123;</span></span><br><span class="line">    <span class="comment">//    LOGGER.info(&quot;result-2:&#123;&#125;&quot;, s);</span></span><br><span class="line">    <span class="comment">//    if (&quot;OK&quot;.equals(s)) &#123;</span></span><br><span class="line">    <span class="comment">//        s = s + &quot;6666&quot;;</span></span><br><span class="line">    <span class="comment">//    &#125; else &#123;</span></span><br><span class="line">    <span class="comment">//        s = s + &quot;9999&quot;;</span></span><br><span class="line">    <span class="comment">//    &#125;</span></span><br><span class="line">    <span class="comment">//    return s;</span></span><br><span class="line">    <span class="comment">//&#125;);</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//test thenApplyAsync ForkJoinPool</span></span><br><span class="line">    <span class="comment">//CompletableFuture&lt;String&gt; completableFuture = supplyAsync.thenApplyAsync(s -&gt; &#123;</span></span><br><span class="line">    <span class="comment">//    LOGGER.info(&quot;result-2:&#123;&#125;&quot;, s);</span></span><br><span class="line">    <span class="comment">//    if (&quot;OK&quot;.equals(s)) &#123;</span></span><br><span class="line">    <span class="comment">//        s = s + &quot;5555&quot;;</span></span><br><span class="line">    <span class="comment">//    &#125; else &#123;</span></span><br><span class="line">    <span class="comment">//        s = s + &quot;6666&quot;;</span></span><br><span class="line">    <span class="comment">//    &#125;</span></span><br><span class="line">    <span class="comment">//    return s;</span></span><br><span class="line">    <span class="comment">//&#125;);</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//test thenApplyAsync</span></span><br><span class="line">    CompletableFuture&lt;String&gt; completableFuture = supplyAsync.thenApplyAsync(s -&gt; &#123;</span><br><span class="line">        LOGGER.info(<span class="string">&quot;result-2:&#123;&#125;&quot;</span>, s);</span><br><span class="line">        <span class="keyword">if</span> (<span class="string">&quot;OK&quot;</span>.equals(s)) &#123;</span><br><span class="line">            s = s + <span class="string">&quot;5555&quot;</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            s = s + <span class="string">&quot;6666&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> s;</span><br><span class="line">    &#125;, threadPoolExecutor);</span><br><span class="line"></span><br><span class="line">    <span class="type">String</span> <span class="variable">result</span> <span class="operator">=</span> completableFuture.get();</span><br><span class="line">    LOGGER.info(<span class="string">&quot;end result:&#123;&#125;&quot;</span>, result);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br><h3 id="handle">2.3.2. handle</h3><p>handle 方法不仅可以处理上一线程的结果，还能处理上一线程中的异常。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">testHandle</span><span class="params">()</span> <span class="keyword">throws</span> ExecutionException, InterruptedException &#123;</span><br><span class="line">    CompletableFuture&lt;String&gt; supplyAsync = CompletableFuture.supplyAsync(<span class="keyword">new</span> <span class="title class_">Supplier</span>&lt;String&gt;() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> String <span class="title function_">get</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">            <span class="type">String</span> <span class="variable">result</span> <span class="operator">=</span> StringUtils.EMPTY;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                TimeUnit.MILLISECONDS.sleep(<span class="number">1000</span>);</span><br><span class="line">                result = shardedJedisOperate.set(<span class="string">&quot;8-key&quot;</span>, <span class="string">&quot;8-value&quot;</span>);</span><br><span class="line">                LOGGER.info(<span class="string">&quot;result-1:&#123;&#125;&quot;</span>, result);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                LOGGER.error(e.getMessage(), e);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            LOGGER.info(<span class="string">&quot;....end-1....&quot;</span>);</span><br><span class="line">            <span class="comment">//模拟异常</span></span><br><span class="line">            <span class="comment">//String[] a = new String[2];</span></span><br><span class="line">            <span class="comment">//LOGGER.info(&quot;index:&#123;&#125;&quot;, a[100]);</span></span><br><span class="line">            <span class="keyword">return</span> result;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;, threadPoolExecutor);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//test handle</span></span><br><span class="line">    <span class="comment">//CompletableFuture&lt;String&gt; handle = supplyAsync.handle(new BiFunction&lt;String, Throwable, String&gt;() &#123;</span></span><br><span class="line">    <span class="comment">//    @Override</span></span><br><span class="line">    <span class="comment">//    public String apply(String s, Throwable throwable) &#123;</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">//        LOGGER.info(&quot;receive info:&#123;&#125;&quot;, s);</span></span><br><span class="line">    <span class="comment">//        try &#123;</span></span><br><span class="line">    <span class="comment">//            if (Objects.nonNull(throwable)) &#123;</span></span><br><span class="line">    <span class="comment">//                LOGGER.warn(&quot;errMsg:&#123;&#125;&quot;, throwable.getMessage());</span></span><br><span class="line">    <span class="comment">//                s = &quot;error&quot;;</span></span><br><span class="line">    <span class="comment">//            &#125; else &#123;</span></span><br><span class="line">    <span class="comment">//                LOGGER.info(&quot;info:&#123;&#125;&quot;, s);</span></span><br><span class="line">    <span class="comment">//                if (&quot;OK&quot;.equals(s)) &#123;</span></span><br><span class="line">    <span class="comment">//                    s += &quot;3333&quot;;</span></span><br><span class="line">    <span class="comment">//                &#125; else &#123;</span></span><br><span class="line">    <span class="comment">//                    s += &quot;4444&quot;;</span></span><br><span class="line">    <span class="comment">//                &#125;</span></span><br><span class="line">    <span class="comment">//            &#125;</span></span><br><span class="line">    <span class="comment">//        &#125; catch (Exception e) &#123;</span></span><br><span class="line">    <span class="comment">//            LOGGER.error(e.getMessage(), e);</span></span><br><span class="line">    <span class="comment">//        &#125; finally &#123;</span></span><br><span class="line">    <span class="comment">//            LOGGER.info(&quot;关闭资源&quot;);</span></span><br><span class="line">    <span class="comment">//            threadPoolExecutor.shutdown();</span></span><br><span class="line">    <span class="comment">//        &#125;</span></span><br><span class="line">    <span class="comment">//        return s;</span></span><br><span class="line">    <span class="comment">//    &#125;</span></span><br><span class="line">    <span class="comment">//&#125;);</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//test handle ForkJoinPool</span></span><br><span class="line">    <span class="comment">//CompletableFuture&lt;String&gt; handle = supplyAsync.handleAsync(new BiFunction&lt;String, Throwable, String&gt;() &#123;</span></span><br><span class="line">    <span class="comment">//    @Override</span></span><br><span class="line">    <span class="comment">//    public String apply(String s, Throwable throwable) &#123;</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">//        LOGGER.info(&quot;receive info:&#123;&#125;&quot;, s);</span></span><br><span class="line">    <span class="comment">//        try &#123;</span></span><br><span class="line">    <span class="comment">//            if (Objects.nonNull(throwable)) &#123;</span></span><br><span class="line">    <span class="comment">//                LOGGER.warn(&quot;errMsg:&#123;&#125;&quot;, throwable.getMessage());</span></span><br><span class="line">    <span class="comment">//                s = &quot;error&quot;;</span></span><br><span class="line">    <span class="comment">//            &#125; else &#123;</span></span><br><span class="line">    <span class="comment">//                LOGGER.info(&quot;info:&#123;&#125;&quot;, s);</span></span><br><span class="line">    <span class="comment">//                if (&quot;OK&quot;.equals(s)) &#123;</span></span><br><span class="line">    <span class="comment">//                    s += &quot;3333&quot;;</span></span><br><span class="line">    <span class="comment">//                &#125; else &#123;</span></span><br><span class="line">    <span class="comment">//                    s += &quot;4444&quot;;</span></span><br><span class="line">    <span class="comment">//                &#125;</span></span><br><span class="line">    <span class="comment">//            &#125;</span></span><br><span class="line">    <span class="comment">//        &#125; catch (Exception e) &#123;</span></span><br><span class="line">    <span class="comment">//            LOGGER.error(e.getMessage(), e);</span></span><br><span class="line">    <span class="comment">//        &#125; finally &#123;</span></span><br><span class="line">    <span class="comment">//            LOGGER.info(&quot;关闭资源&quot;);</span></span><br><span class="line">    <span class="comment">//            threadPoolExecutor.shutdown();</span></span><br><span class="line">    <span class="comment">//        &#125;</span></span><br><span class="line">    <span class="comment">//        return s;</span></span><br><span class="line">    <span class="comment">//    &#125;</span></span><br><span class="line">    <span class="comment">//&#125;);</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//test handle Executor</span></span><br><span class="line">    CompletableFuture&lt;String&gt; handle = supplyAsync.handleAsync(<span class="keyword">new</span> <span class="title class_">BiFunction</span>&lt;String, Throwable, String&gt;() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> String <span class="title function_">apply</span><span class="params">(String s, Throwable throwable)</span> &#123;</span><br><span class="line"></span><br><span class="line">            LOGGER.info(<span class="string">&quot;receive info:&#123;&#125;&quot;</span>, s);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (Objects.nonNull(throwable)) &#123;</span><br><span class="line">                    LOGGER.warn(<span class="string">&quot;errMsg:&#123;&#125;&quot;</span>, throwable.getMessage());</span><br><span class="line">                    s = <span class="string">&quot;error&quot;</span>;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    LOGGER.info(<span class="string">&quot;info:&#123;&#125;&quot;</span>, s);</span><br><span class="line">                    <span class="keyword">if</span> (<span class="string">&quot;OK&quot;</span>.equals(s)) &#123;</span><br><span class="line">                        s += <span class="string">&quot;3333&quot;</span>;</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        s += <span class="string">&quot;4444&quot;</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                LOGGER.error(e.getMessage(), e);</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                LOGGER.info(<span class="string">&quot;关闭资源&quot;</span>);</span><br><span class="line">                threadPoolExecutor.shutdown();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> s;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;, threadPoolExecutor);</span><br><span class="line"></span><br><span class="line">    <span class="type">String</span> <span class="variable">result</span> <span class="operator">=</span> handle.get();</span><br><span class="line">    LOGGER.info(<span class="string">&quot;end result:&#123;&#125;&quot;</span>, result);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br><h2 id="thenAccept、thenRun">2.4. thenAccept、thenRun</h2><p>接收上一个线程的结果，纯消费、处理 ，无结果返回。</p><p>thenRun 跟 thenAccept 方法不一样的是，thenRun 不关心上一线程的处理结果。只要上一线程执行完成，就开始执行 thenRun。而 thenAccept 能接收上一线程的结果。</p><p>可以当做后置处理。</p><table><thead><tr><th>方法</th><th>入参</th><th>注意</th></tr></thead><tbody><tr><td>thenAccept</td><td>thenAccept(Consumer&lt;? super T&gt; action)</td><td>接收上一线程的结果。纯处理，无返回结果。</td></tr><tr><td>thenAcceptAsync</td><td>thenAcceptAsync(Consumer&lt;? super T&gt; action)<br><br>thenAcceptAsync(Consumer&lt;? super T&gt; action,Executor executor)</td><td>使用 ForkJoinPool 线程池<br><br>使用 Executor 自定义线程池</td></tr><tr><td>thenRun</td><td>thenRun(Runnable action)</td><td>不关心上一线程结果。纯处理，无返回结果。入参是runnable线程。</td></tr><tr><td>thenRunAsync</td><td>thenRunAsync(Runnable action)<br><br>thenRunAsync(Runnable action,Executor executor)</td><td>使用 ForkJoinPool 线程池<br><br>使用 Executor 自定义线程池</td></tr></tbody></table><br><h3 id="thenAccept">2.4.1. thenAccept</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">testThenAccept</span><span class="params">()</span> <span class="keyword">throws</span> ExecutionException, InterruptedException &#123;</span><br><span class="line">    CompletableFuture&lt;String&gt; supplyAsync = CompletableFuture.supplyAsync(<span class="keyword">new</span> <span class="title class_">Supplier</span>&lt;String&gt;() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> String <span class="title function_">get</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">result</span> <span class="operator">=</span> StringUtils.EMPTY;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                TimeUnit.MILLISECONDS.sleep(<span class="number">1000</span>);</span><br><span class="line">                result = shardedJedisOperate.set(<span class="string">&quot;10-key&quot;</span>, <span class="string">&quot;10-value&quot;</span>);</span><br><span class="line">                LOGGER.info(<span class="string">&quot;result-1:&#123;&#125;&quot;</span>, result);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                LOGGER.error(e.getMessage(), e);</span><br><span class="line">            &#125;</span><br><span class="line">            LOGGER.info(<span class="string">&quot;....end-1....&quot;</span>);</span><br><span class="line">            <span class="comment">//模拟异常</span></span><br><span class="line">            <span class="comment">//String[] a = new String[2];</span></span><br><span class="line">            <span class="comment">//LOGGER.info(&quot;index:&#123;&#125;&quot;, a[100]);</span></span><br><span class="line">            <span class="keyword">return</span> result;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;, threadPoolExecutor);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//thenAccept ForkJoinPool</span></span><br><span class="line">    <span class="comment">//CompletableFuture&lt;Void&gt; thenAccept = supplyAsync.thenAccept(new Consumer&lt;String&gt;() &#123;</span></span><br><span class="line">    <span class="comment">//    @Override</span></span><br><span class="line">    <span class="comment">//    public void accept(String s) &#123;</span></span><br><span class="line">    <span class="comment">//        LOGGER.info(&quot;receive msg:&#123;&#125;,模拟推送kafka&quot;, s);</span></span><br><span class="line">    <span class="comment">//    &#125;</span></span><br><span class="line">    <span class="comment">//&#125;);</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//thenAcceptAsync ForkJoinPool</span></span><br><span class="line">    <span class="comment">//CompletableFuture&lt;Void&gt; thenAccept = supplyAsync.thenAcceptAsync(new Consumer&lt;String&gt;() &#123;</span></span><br><span class="line">    <span class="comment">//    @Override</span></span><br><span class="line">    <span class="comment">//    public void accept(String s) &#123;</span></span><br><span class="line">    <span class="comment">//        LOGGER.info(&quot;receive msg:&#123;&#125;,模拟推送kafka&quot;, s);</span></span><br><span class="line">    <span class="comment">//    &#125;</span></span><br><span class="line">    <span class="comment">//&#125;);</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//thenAcceptAsync Executor</span></span><br><span class="line">    CompletableFuture&lt;Void&gt; thenAccept = supplyAsync.thenAcceptAsync(<span class="keyword">new</span> <span class="title class_">Consumer</span>&lt;String&gt;() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">accept</span><span class="params">(String s)</span> &#123;</span><br><span class="line">            LOGGER.info(<span class="string">&quot;receive msg:&#123;&#125;,模拟推送kafka&quot;</span>, s);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;, threadPoolExecutor);</span><br><span class="line"></span><br><span class="line">    thenAccept.get();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br><h3 id="thenRun">2.4.2. thenRun</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">testThenRun</span><span class="params">()</span> <span class="keyword">throws</span> ExecutionException, InterruptedException &#123;</span><br><span class="line">    CompletableFuture&lt;String&gt; supplyAsync = CompletableFuture.supplyAsync(<span class="keyword">new</span> <span class="title class_">Supplier</span>&lt;String&gt;() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> String <span class="title function_">get</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">result</span> <span class="operator">=</span> StringUtils.EMPTY;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                TimeUnit.MILLISECONDS.sleep(<span class="number">1000</span>);</span><br><span class="line">                result = shardedJedisOperate.set(<span class="string">&quot;11-key&quot;</span>, <span class="string">&quot;11-value&quot;</span>);</span><br><span class="line">                LOGGER.info(<span class="string">&quot;result-1:&#123;&#125;&quot;</span>, result);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                LOGGER.error(e.getMessage(), e);</span><br><span class="line">            &#125;</span><br><span class="line">            LOGGER.info(<span class="string">&quot;....end-1....&quot;</span>);</span><br><span class="line">            <span class="comment">//模拟异常</span></span><br><span class="line">            <span class="comment">//String[] a = new String[2];</span></span><br><span class="line">            <span class="comment">//LOGGER.info(&quot;index:&#123;&#125;&quot;, a[100]);</span></span><br><span class="line">            <span class="keyword">return</span> result;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;, threadPoolExecutor);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//CompletableFuture&lt;Void&gt; thenRun = supplyAsync.thenRun(new Runnable() &#123;</span></span><br><span class="line">    <span class="comment">//    @Override</span></span><br><span class="line">    <span class="comment">//    public void run() &#123;</span></span><br><span class="line">    <span class="comment">//        LOGGER.info(&quot;runnable线程，不关心上一线程结果&quot;);</span></span><br><span class="line">    <span class="comment">//        LOGGER.info(&quot;后置处理.....&quot;);</span></span><br><span class="line">    <span class="comment">//    &#125;</span></span><br><span class="line">    <span class="comment">//&#125;);</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//CompletableFuture&lt;Void&gt; thenRun = supplyAsync.thenRunAsync(new Runnable() &#123;</span></span><br><span class="line">    <span class="comment">//    @Override</span></span><br><span class="line">    <span class="comment">//    public void run() &#123;</span></span><br><span class="line">    <span class="comment">//        LOGGER.info(&quot;runnable线程，不关心上一线程结果&quot;);</span></span><br><span class="line">    <span class="comment">//        LOGGER.info(&quot;后置处理.....&quot;);</span></span><br><span class="line">    <span class="comment">//    &#125;</span></span><br><span class="line">    <span class="comment">//&#125;);</span></span><br><span class="line"></span><br><span class="line">    CompletableFuture&lt;Void&gt; thenRun = supplyAsync.thenRunAsync(<span class="keyword">new</span> <span class="title class_">Runnable</span>() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">            LOGGER.info(<span class="string">&quot;runnable线程，不关心上一线程结果&quot;</span>);</span><br><span class="line">            LOGGER.info(<span class="string">&quot;后置处理.....&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;, threadPoolExecutor);</span><br><span class="line"></span><br><span class="line">    thenRun.get();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br><h2 id="thenCombine、thenAcceptBoth">2.5. thenCombine、thenAcceptBoth</h2><p>thenCombine、thenAcceptBoth 用来合并任务。</p><p>等待两个 CompletionStage 的任务都执行完成后，把两个任务的结果一并来处理。</p><p>区别在于 thenCombine 有返回值；thenAcceptBoth 无返回值</p><table><thead><tr><th>方法</th><th>入参</th><th>注意</th></tr></thead><tbody><tr><td>thenCombine</td><td>thenCombine(CompletionStage&lt;? extends U&gt; other,BiFunction&lt;? super T,? super U,? extends V&gt; fn)</td><td></td></tr><tr><td>thenCombineAsync</td><td>thenCombineAsync(CompletionStage&lt;? extends U&gt; other,BiFunction&lt;? super T,? super U,? extends V&gt; fn)<br><br>thenCombineAsync(CompletionStage&lt;? extends U&gt; other,BiFunction&lt;? super T,? super U,? extends V&gt; fn, Executor executor)</td><td></td></tr><tr><td>thenAcceptBoth</td><td>thenAcceptBoth(CompletionStage&lt;? extends U&gt; other,BiConsumer&lt;? super T, ? super U&gt; action)</td><td></td></tr><tr><td>thenAcceptBothAsync</td><td>thenAcceptBothAsync(CompletionStage&lt;? extends U&gt; other,BiConsumer&lt;? super T, ? super U&gt; action)<br><br>thenAcceptBothAsync(CompletionStage&lt;? extends U&gt; other,BiConsumer&lt;? super T, ? super U&gt; action, Executor executor)</td><td>使用 ForkJoinPool 线程池<br><br>使用 Executor 自定义线程池</td></tr></tbody></table><br><h3 id="thenCombine">2.5.1. thenCombine</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">testThenCombine</span><span class="params">()</span> <span class="keyword">throws</span> ExecutionException, InterruptedException &#123;</span><br><span class="line">    CompletableFuture&lt;String&gt; supplyAsync1 = CompletableFuture.supplyAsync(() -&gt; &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">result</span> <span class="operator">=</span> StringUtils.EMPTY;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            TimeUnit.MILLISECONDS.sleep(<span class="number">1000</span>);</span><br><span class="line">            result = shardedJedisOperate.set(<span class="string">&quot;12-key&quot;</span>, <span class="string">&quot;12-value&quot;</span>);</span><br><span class="line">            LOGGER.info(<span class="string">&quot;result-1:&#123;&#125;&quot;</span>, result);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            LOGGER.error(e.getMessage(), e);</span><br><span class="line">        &#125;</span><br><span class="line">        LOGGER.info(<span class="string">&quot;....end-1....&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;, threadPoolExecutor);</span><br><span class="line"></span><br><span class="line">    CompletableFuture&lt;String&gt; supplyAsync2 = CompletableFuture.supplyAsync(() -&gt; &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">result</span> <span class="operator">=</span> StringUtils.EMPTY;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            TimeUnit.MILLISECONDS.sleep(<span class="number">1000</span>);</span><br><span class="line">            result = shardedJedisOperate.set(<span class="string">&quot;13-key&quot;</span>, <span class="string">&quot;13-value&quot;</span>);</span><br><span class="line">            LOGGER.info(<span class="string">&quot;result-2:&#123;&#125;&quot;</span>, result);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            LOGGER.error(e.getMessage(), e);</span><br><span class="line">        &#125;</span><br><span class="line">        LOGGER.info(<span class="string">&quot;....end-2....&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;, threadPoolExecutor);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// thenCombine</span></span><br><span class="line">    <span class="comment">//CompletableFuture&lt;String&gt; thenCombine = supplyAsync1.thenCombine(supplyAsync2, new BiFunction&lt;String, String, String&gt;() &#123;</span></span><br><span class="line">    <span class="comment">//    @Override</span></span><br><span class="line">    <span class="comment">//    public String apply(String s, String s2) &#123;</span></span><br><span class="line">    <span class="comment">//        return s + &quot; 666 &quot; + s2;</span></span><br><span class="line">    <span class="comment">//    &#125;</span></span><br><span class="line">    <span class="comment">//&#125;);</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// thenCombineAsync</span></span><br><span class="line">    <span class="comment">//CompletableFuture&lt;String&gt; thenCombine = supplyAsync1.thenCombineAsync(supplyAsync2, new BiFunction&lt;String, String, String&gt;() &#123;</span></span><br><span class="line">    <span class="comment">//    @Override</span></span><br><span class="line">    <span class="comment">//    public String apply(String s, String s2) &#123;</span></span><br><span class="line">    <span class="comment">//        return s + &quot; 666 &quot; + s2;</span></span><br><span class="line">    <span class="comment">//    &#125;</span></span><br><span class="line">    <span class="comment">//&#125;);</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// thenCombineAsync Executor</span></span><br><span class="line">    CompletableFuture&lt;String&gt; thenCombine = supplyAsync1.thenCombineAsync(supplyAsync2, <span class="keyword">new</span> <span class="title class_">BiFunction</span>&lt;String, String, String&gt;() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> String <span class="title function_">apply</span><span class="params">(String s, String s2)</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> s + <span class="string">&quot; 666 &quot;</span> + s2;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;, threadPoolExecutor);</span><br><span class="line"></span><br><span class="line">    <span class="type">String</span> <span class="variable">result</span> <span class="operator">=</span> thenCombine.get();</span><br><span class="line">    LOGGER.info(<span class="string">&quot;end result:&#123;&#125;&quot;</span>, result);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br><h3 id="thenAcceptBoth">2.5.2. thenAcceptBoth</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">testThenAcceptBoth</span><span class="params">()</span> <span class="keyword">throws</span> ExecutionException, InterruptedException &#123;</span><br><span class="line">    CompletableFuture&lt;String&gt; supplyAsync1 = CompletableFuture.supplyAsync(() -&gt; &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">result</span> <span class="operator">=</span> StringUtils.EMPTY;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            TimeUnit.MILLISECONDS.sleep(<span class="number">1000</span>);</span><br><span class="line">            result = shardedJedisOperate.set(<span class="string">&quot;12-key&quot;</span>, <span class="string">&quot;12-value&quot;</span>);</span><br><span class="line">            LOGGER.info(<span class="string">&quot;result-1:&#123;&#125;&quot;</span>, result);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            LOGGER.error(e.getMessage(), e);</span><br><span class="line">        &#125;</span><br><span class="line">        LOGGER.info(<span class="string">&quot;....end-1....&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;, threadPoolExecutor);</span><br><span class="line"></span><br><span class="line">    CompletableFuture&lt;String&gt; supplyAsync2 = CompletableFuture.supplyAsync(() -&gt; &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">result</span> <span class="operator">=</span> StringUtils.EMPTY;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            TimeUnit.MILLISECONDS.sleep(<span class="number">1000</span>);</span><br><span class="line">            result = shardedJedisOperate.set(<span class="string">&quot;13-key&quot;</span>, <span class="string">&quot;13-value&quot;</span>);</span><br><span class="line">            LOGGER.info(<span class="string">&quot;result-2:&#123;&#125;&quot;</span>, result);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            LOGGER.error(e.getMessage(), e);</span><br><span class="line">        &#125;</span><br><span class="line">        LOGGER.info(<span class="string">&quot;....end-2....&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;, threadPoolExecutor);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//thenAcceptBoth</span></span><br><span class="line">    <span class="comment">//CompletableFuture&lt;Void&gt; thenAcceptBoth = supplyAsync1.thenAcceptBoth(supplyAsync2, new BiConsumer&lt;String, String&gt;() &#123;</span></span><br><span class="line">    <span class="comment">//    @Override</span></span><br><span class="line">    <span class="comment">//    public void accept(String s, String s2) &#123;</span></span><br><span class="line">    <span class="comment">//        LOGGER.info(&quot;receive s:&#123;&#125;,s2:&#123;&#125;&quot;, s, s2);</span></span><br><span class="line">    <span class="comment">//        LOGGER.info(&quot;合并数据，模拟推送kafka....&quot;);</span></span><br><span class="line">    <span class="comment">//    &#125;</span></span><br><span class="line">    <span class="comment">//&#125;);</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//thenAcceptBothAsync ForkJoinPool</span></span><br><span class="line">    <span class="comment">//CompletableFuture&lt;Void&gt; thenAcceptBoth = supplyAsync1.thenAcceptBothAsync(supplyAsync2, new BiConsumer&lt;String, String&gt;() &#123;</span></span><br><span class="line">    <span class="comment">//    @Override</span></span><br><span class="line">    <span class="comment">//    public void accept(String s, String s2) &#123;</span></span><br><span class="line">    <span class="comment">//        LOGGER.info(&quot;receive s:&#123;&#125;,s2:&#123;&#125;&quot;, s, s2);</span></span><br><span class="line">    <span class="comment">//        LOGGER.info(&quot;合并数据，模拟推送kafka....&quot;);</span></span><br><span class="line">    <span class="comment">//    &#125;</span></span><br><span class="line">    <span class="comment">//&#125;);</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//thenAcceptBothAsync Executor</span></span><br><span class="line">    CompletableFuture&lt;Void&gt; thenAcceptBoth = supplyAsync1.thenAcceptBothAsync(supplyAsync2, <span class="keyword">new</span> <span class="title class_">BiConsumer</span>&lt;String, String&gt;() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">accept</span><span class="params">(String s, String s2)</span> &#123;</span><br><span class="line">            LOGGER.info(<span class="string">&quot;receive s:&#123;&#125;,s2:&#123;&#125;&quot;</span>, s, s2);</span><br><span class="line">            LOGGER.info(<span class="string">&quot;合并数据，模拟推送kafka....&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;, threadPoolExecutor);</span><br><span class="line"></span><br><span class="line">    thenAcceptBoth.get();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br><h2 id="applyToEither-、acceptEither">2.6. applyToEither 、acceptEither</h2><p>当任意一个 CompletableFuture 完成的时候，fn会被执行，它的返回值会当作新的 CompletableFuture 的计算结果。</p><p>两个 CompletableFuture ，任意一个 CompletableFuture 执行完（返回结果快），就取哪个 CompletableFuture 的结果，调用 applyToEither 处理。</p><table><thead><tr><th>方法</th><th>入参</th><th>注意</th></tr></thead><tbody><tr><td>applyToEither</td><td>applyToEither(CompletionStage&lt;? extends T&gt; other, Function&lt;? super T, U&gt; fn)</td><td>有返回值</td></tr><tr><td>applyToEitherAsync</td><td>applyToEitherAsync(CompletionStage&lt;? extends T&gt; other, Function&lt;? super T, U&gt; fn)<br><br>applyToEitherAsync(CompletionStage&lt;? extends T&gt; other, Function&lt;? super T, U&gt; fn,Executor executor)</td><td>有返回值，使用 ForkJoinPool 线程池<br><br>有返回值，使用 Executor 自定义线程池</td></tr><tr><td>acceptEither</td><td>acceptEither(CompletionStage&lt;? extends T&gt; other, Consumer&lt;? super T&gt; action)</td><td>无返回值</td></tr><tr><td>acceptEitherAsync</td><td>acceptEitherAsync(CompletionStage&lt;? extends T&gt; other, Consumer&lt;? super T&gt; action)<br><br>acceptEitherAsync(CompletionStage&lt;? extends T&gt; other, Consumer&lt;? super T&gt; action,Executor executor)</td><td>无返回值，使用 ForkJoinPool 线程池<br><br>无返回值，使用 Executor 自定义线程池</td></tr></tbody></table><br><h3 id="applyToEither">2.6.1. applyToEither</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">testApplyToEither</span><span class="params">()</span> <span class="keyword">throws</span> ExecutionException, InterruptedException &#123;</span><br><span class="line"></span><br><span class="line">    CompletableFuture&lt;String&gt; supplyAsync1 = CompletableFuture.supplyAsync(() -&gt; &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">result</span> <span class="operator">=</span> StringUtils.EMPTY;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            TimeUnit.MILLISECONDS.sleep((<span class="type">long</span>) (Math.random() * <span class="number">1500</span>));</span><br><span class="line">            result = shardedJedisOperate.set(<span class="string">&quot;14-key&quot;</span>, <span class="string">&quot;14-value&quot;</span>);</span><br><span class="line">            result += <span class="string">&quot;555&quot;</span>;</span><br><span class="line">            LOGGER.info(<span class="string">&quot;result-1:&#123;&#125;&quot;</span>, result);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            LOGGER.error(e.getMessage(), e);</span><br><span class="line">        &#125;</span><br><span class="line">        LOGGER.info(<span class="string">&quot;....end-1....&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;, threadPoolExecutor);</span><br><span class="line"></span><br><span class="line">    CompletableFuture&lt;String&gt; supplyAsync2 = CompletableFuture.supplyAsync(() -&gt; &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">result</span> <span class="operator">=</span> StringUtils.EMPTY;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            TimeUnit.MILLISECONDS.sleep((<span class="type">long</span>) (Math.random() * <span class="number">1000</span>));</span><br><span class="line">            result = shardedJedisOperate.set(<span class="string">&quot;15-key&quot;</span>, <span class="string">&quot;15-value&quot;</span>);</span><br><span class="line">            result += <span class="string">&quot;666&quot;</span>;</span><br><span class="line">            LOGGER.info(<span class="string">&quot;result-2:&#123;&#125;&quot;</span>, result);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            LOGGER.error(e.getMessage(), e);</span><br><span class="line">        &#125;</span><br><span class="line">        LOGGER.info(<span class="string">&quot;....end-2....&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;, threadPoolExecutor);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//applyToEither</span></span><br><span class="line">    <span class="comment">//CompletableFuture&lt;String&gt; applyToEither = supplyAsync1.applyToEither(supplyAsync2, new Function&lt;String, String&gt;() &#123;</span></span><br><span class="line">    <span class="comment">//    @Override</span></span><br><span class="line">    <span class="comment">//    public String apply(String s) &#123;</span></span><br><span class="line">    <span class="comment">//        LOGGER.info(&quot;first result:&#123;&#125;&quot;, s);</span></span><br><span class="line">    <span class="comment">//        return s;</span></span><br><span class="line">    <span class="comment">//    &#125;</span></span><br><span class="line">    <span class="comment">//&#125;);</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//applyToEitherAsync ForkJoinPool</span></span><br><span class="line">    <span class="comment">//CompletableFuture&lt;String&gt; applyToEither = supplyAsync1.applyToEitherAsync(supplyAsync2, new Function&lt;String, String&gt;() &#123;</span></span><br><span class="line">    <span class="comment">//    @Override</span></span><br><span class="line">    <span class="comment">//    public String apply(String s) &#123;</span></span><br><span class="line">    <span class="comment">//        LOGGER.info(&quot;first result:&#123;&#125;&quot;, s);</span></span><br><span class="line">    <span class="comment">//        return s;</span></span><br><span class="line">    <span class="comment">//    &#125;</span></span><br><span class="line">    <span class="comment">//&#125;);</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//applyToEitherAsync Executor</span></span><br><span class="line">    CompletableFuture&lt;String&gt; applyToEither = supplyAsync1.applyToEitherAsync(supplyAsync2, <span class="keyword">new</span> <span class="title class_">Function</span>&lt;String, String&gt;() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> String <span class="title function_">apply</span><span class="params">(String s)</span> &#123;</span><br><span class="line">            LOGGER.info(<span class="string">&quot;first result:&#123;&#125;&quot;</span>, s);</span><br><span class="line">            <span class="keyword">return</span> s;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;, threadPoolExecutor);</span><br><span class="line"></span><br><span class="line">    <span class="type">String</span> <span class="variable">result</span> <span class="operator">=</span> applyToEither.get();</span><br><span class="line">    LOGGER.info(<span class="string">&quot;end result:&#123;&#125;&quot;</span>, result);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br><h3 id="acceptEither">2.6.2. acceptEither</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">testAcceptEither</span><span class="params">()</span> <span class="keyword">throws</span> ExecutionException, InterruptedException &#123;</span><br><span class="line">    CompletableFuture&lt;String&gt; supplyAsync1 = CompletableFuture.supplyAsync(() -&gt; &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">result</span> <span class="operator">=</span> StringUtils.EMPTY;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            TimeUnit.MILLISECONDS.sleep((<span class="type">long</span>) (Math.random() * <span class="number">1500</span>));</span><br><span class="line">            result = shardedJedisOperate.set(<span class="string">&quot;16-key&quot;</span>, <span class="string">&quot;16-value&quot;</span>);</span><br><span class="line">            result += <span class="string">&quot;111&quot;</span>;</span><br><span class="line">            LOGGER.info(<span class="string">&quot;result-1:&#123;&#125;&quot;</span>, result);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            LOGGER.error(e.getMessage(), e);</span><br><span class="line">        &#125;</span><br><span class="line">        LOGGER.info(<span class="string">&quot;....end-1....&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;, threadPoolExecutor);</span><br><span class="line"></span><br><span class="line">    CompletableFuture&lt;String&gt; supplyAsync2 = CompletableFuture.supplyAsync(() -&gt; &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">result</span> <span class="operator">=</span> StringUtils.EMPTY;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            TimeUnit.MILLISECONDS.sleep((<span class="type">long</span>) (Math.random() * <span class="number">1000</span>));</span><br><span class="line">            result = shardedJedisOperate.set(<span class="string">&quot;17-key&quot;</span>, <span class="string">&quot;17-value&quot;</span>);</span><br><span class="line">            result += <span class="string">&quot;333&quot;</span>;</span><br><span class="line">            LOGGER.info(<span class="string">&quot;result-2:&#123;&#125;&quot;</span>, result);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            LOGGER.error(e.getMessage(), e);</span><br><span class="line">        &#125;</span><br><span class="line">        LOGGER.info(<span class="string">&quot;....end-2....&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;, threadPoolExecutor);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//acceptEither</span></span><br><span class="line">    <span class="comment">//CompletableFuture&lt;Void&gt; acceptEither = supplyAsync1.acceptEither(supplyAsync2, new Consumer&lt;String&gt;() &#123;</span></span><br><span class="line">    <span class="comment">//    @Override</span></span><br><span class="line">    <span class="comment">//    public void accept(String s) &#123;</span></span><br><span class="line">    <span class="comment">//        LOGGER.info(&quot;receive msg:&#123;&#125;&quot;, s);</span></span><br><span class="line">    <span class="comment">//    &#125;</span></span><br><span class="line">    <span class="comment">//&#125;);</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//acceptEitherAsync ForkJoinPool</span></span><br><span class="line">    <span class="comment">//CompletableFuture&lt;Void&gt; acceptEither = supplyAsync1.acceptEitherAsync(supplyAsync2, new Consumer&lt;String&gt;() &#123;</span></span><br><span class="line">    <span class="comment">//    @Override</span></span><br><span class="line">    <span class="comment">//    public void accept(String s) &#123;</span></span><br><span class="line">    <span class="comment">//        LOGGER.info(&quot;receive msg:&#123;&#125;&quot;, s);</span></span><br><span class="line">    <span class="comment">//    &#125;</span></span><br><span class="line">    <span class="comment">//&#125;);</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//acceptEitherAsync Executor</span></span><br><span class="line">    CompletableFuture&lt;Void&gt; acceptEither = supplyAsync1.acceptEitherAsync(supplyAsync2, <span class="keyword">new</span> <span class="title class_">Consumer</span>&lt;String&gt;() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">accept</span><span class="params">(String s)</span> &#123;</span><br><span class="line">            LOGGER.info(<span class="string">&quot;receive msg:&#123;&#125;&quot;</span>, s);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;, threadPoolExecutor);</span><br><span class="line"></span><br><span class="line">    acceptEither.get();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br><h2 id="runAfterEither-、runAfterBoth">2.7. runAfterEither 、runAfterBoth</h2><p>runAfterEither：两个互不相干的任务A和B，只要任何一个完成就触发执行线程Runnable</p><p>两个 CompletionStage，都完成了计算才会执行下一步的操作（Runnable），无返回值。</p><table><thead><tr><th>方法</th><th>入参</th><th>注意</th></tr></thead><tbody><tr><td>runAfterEither</td><td>runAfterEither(CompletionStage&lt;?&gt; other,Runnable action)</td><td>Runnable线程</td></tr><tr><td>runAfterEitherAsync</td><td>runAfterEitherAsync(CompletionStage&lt;&#x2F;?&gt; other,Runnable action)<br><br>runAfterEitherAsync(CompletionStage&lt;&#x2F;?&gt; other,Runnable action,Executor executor)</td><td>使用 ForkJoinPool 线程池<br><br>使用 Executor 自定义线程池</td></tr><tr><td>runAfterBoth</td><td>runAfterBoth(CompletionStage&lt;?&gt; other,Runnable action)</td><td></td></tr><tr><td>runAfterBothAsync</td><td>-</td><td>-</td></tr></tbody></table><br><h3 id="runAfterEither">2.7.1. runAfterEither</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">testRunAfterEither</span><span class="params">()</span> <span class="keyword">throws</span> ExecutionException, InterruptedException &#123;</span><br><span class="line">    CompletableFuture&lt;String&gt; supplyAsync1 = CompletableFuture.supplyAsync(() -&gt; &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">result</span> <span class="operator">=</span> StringUtils.EMPTY;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            TimeUnit.MILLISECONDS.sleep((<span class="type">long</span>) (Math.random() * <span class="number">1500</span>));</span><br><span class="line">            result = shardedJedisOperate.set(<span class="string">&quot;18-key&quot;</span>, <span class="string">&quot;18-value&quot;</span>);</span><br><span class="line">            result += <span class="string">&quot;000&quot;</span>;</span><br><span class="line">            LOGGER.info(<span class="string">&quot;result-1:&#123;&#125;&quot;</span>, result);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            LOGGER.error(e.getMessage(), e);</span><br><span class="line">        &#125;</span><br><span class="line">        LOGGER.info(<span class="string">&quot;....end-1....&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;, threadPoolExecutor);</span><br><span class="line"></span><br><span class="line">    CompletableFuture&lt;String&gt; supplyAsync2 = CompletableFuture.supplyAsync(() -&gt; &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">result</span> <span class="operator">=</span> StringUtils.EMPTY;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            TimeUnit.MILLISECONDS.sleep((<span class="type">long</span>) (Math.random() * <span class="number">1000</span>));</span><br><span class="line">            result = shardedJedisOperate.set(<span class="string">&quot;19-key&quot;</span>, <span class="string">&quot;19-value&quot;</span>);</span><br><span class="line">            result += <span class="string">&quot;222&quot;</span>;</span><br><span class="line">            LOGGER.info(<span class="string">&quot;result-2:&#123;&#125;&quot;</span>, result);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            LOGGER.error(e.getMessage(), e);</span><br><span class="line">        &#125;</span><br><span class="line">        LOGGER.info(<span class="string">&quot;....end-2....&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;, threadPoolExecutor);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//test runAfterEither</span></span><br><span class="line">    <span class="comment">//CompletableFuture&lt;Void&gt; runAfterEither = supplyAsync1.runAfterEither(supplyAsync2, new Runnable() &#123;</span></span><br><span class="line">    <span class="comment">//    @Override</span></span><br><span class="line">    <span class="comment">//    public void run() &#123;</span></span><br><span class="line">    <span class="comment">//        LOGGER.info(&quot;触发某些业务.....&quot;);</span></span><br><span class="line">    <span class="comment">//    &#125;</span></span><br><span class="line">    <span class="comment">//&#125;);</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//runAfterEitherAsync ForkJoinPool</span></span><br><span class="line">    <span class="comment">//CompletableFuture&lt;Void&gt; runAfterEither = supplyAsync1.runAfterEitherAsync(supplyAsync2, new Runnable() &#123;</span></span><br><span class="line">    <span class="comment">//    @Override</span></span><br><span class="line">    <span class="comment">//    public void run() &#123;</span></span><br><span class="line">    <span class="comment">//        LOGGER.info(&quot;触发某些业务.....&quot;);</span></span><br><span class="line">    <span class="comment">//    &#125;</span></span><br><span class="line">    <span class="comment">//&#125;);</span></span><br><span class="line"></span><br><span class="line">    CompletableFuture&lt;Void&gt; runAfterEither = supplyAsync1.runAfterEitherAsync(supplyAsync2, <span class="keyword">new</span> <span class="title class_">Runnable</span>() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">            LOGGER.info(<span class="string">&quot;触发某些业务.....&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;, threadPoolExecutor);</span><br><span class="line"></span><br><span class="line">    runAfterEither.get();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br><h3 id="runAfterBoth">2.7.2. runAfterBoth</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">testRunAfterBoth</span><span class="params">()</span> <span class="keyword">throws</span> ExecutionException, InterruptedException &#123;</span><br><span class="line">    CompletableFuture&lt;String&gt; supplyAsync1 = CompletableFuture.supplyAsync(() -&gt; &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">result</span> <span class="operator">=</span> StringUtils.EMPTY;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            TimeUnit.MILLISECONDS.sleep((<span class="type">long</span>) (Math.random() * <span class="number">1500</span>));</span><br><span class="line">            result = shardedJedisOperate.set(<span class="string">&quot;20-key&quot;</span>, <span class="string">&quot;20-value&quot;</span>);</span><br><span class="line">            result += <span class="string">&quot;777&quot;</span>;</span><br><span class="line">            LOGGER.info(<span class="string">&quot;result-1:&#123;&#125;&quot;</span>, result);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            LOGGER.error(e.getMessage(), e);</span><br><span class="line">        &#125;</span><br><span class="line">        LOGGER.info(<span class="string">&quot;....end-1....&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;, threadPoolExecutor);</span><br><span class="line"></span><br><span class="line">    CompletableFuture&lt;String&gt; supplyAsync2 = CompletableFuture.supplyAsync(() -&gt; &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">result</span> <span class="operator">=</span> StringUtils.EMPTY;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            TimeUnit.MILLISECONDS.sleep((<span class="type">long</span>) (Math.random() * <span class="number">1000</span>));</span><br><span class="line">            result = shardedJedisOperate.set(<span class="string">&quot;21-key&quot;</span>, <span class="string">&quot;21-value&quot;</span>);</span><br><span class="line">            result += <span class="string">&quot;888&quot;</span>;</span><br><span class="line">            LOGGER.info(<span class="string">&quot;result-2:&#123;&#125;&quot;</span>, result);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            LOGGER.error(e.getMessage(), e);</span><br><span class="line">        &#125;</span><br><span class="line">        LOGGER.info(<span class="string">&quot;....end-2....&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;, threadPoolExecutor);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//CompletableFuture&lt;Void&gt; runAfterBoth = supplyAsync1.runAfterBoth(supplyAsync2, new Runnable() &#123;</span></span><br><span class="line">    <span class="comment">//    @Override</span></span><br><span class="line">    <span class="comment">//    public void run() &#123;</span></span><br><span class="line">    <span class="comment">//        LOGGER.info(&quot;触发某些业务.....&quot;);</span></span><br><span class="line">    <span class="comment">//    &#125;</span></span><br><span class="line">    <span class="comment">//&#125;);</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//runAfterBothAsync ForkJoinPool</span></span><br><span class="line">    <span class="comment">//CompletableFuture&lt;Void&gt; runAfterBoth = supplyAsync1.runAfterBothAsync(supplyAsync2, new Runnable() &#123;</span></span><br><span class="line">    <span class="comment">//    @Override</span></span><br><span class="line">    <span class="comment">//    public void run() &#123;</span></span><br><span class="line">    <span class="comment">//        LOGGER.info(&quot;触发某些业务.....&quot;);</span></span><br><span class="line">    <span class="comment">//    &#125;</span></span><br><span class="line">    <span class="comment">//&#125;);</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//runAfterBothAsync Executor</span></span><br><span class="line">    CompletableFuture&lt;Void&gt; runAfterBoth = supplyAsync1.runAfterBothAsync(supplyAsync2, <span class="keyword">new</span> <span class="title class_">Runnable</span>() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">            LOGGER.info(<span class="string">&quot;触发某些业务.....&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;, threadPoolExecutor);</span><br><span class="line">    runAfterBoth.get();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br><h2 id="thenCompose">2.8. thenCompose</h2><p>组合多个CompletableFuture，将前一个结果作为下一个计算的参数，它们之间存在着先后顺序。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">testThenCompose</span><span class="params">()</span> <span class="keyword">throws</span> ExecutionException, InterruptedException &#123;</span><br><span class="line">    CompletableFuture&lt;String&gt; supplyAsync1 = CompletableFuture.supplyAsync(() -&gt; &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">result</span> <span class="operator">=</span> StringUtils.EMPTY;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            TimeUnit.MILLISECONDS.sleep((<span class="type">long</span>) (Math.random() * <span class="number">1500</span>));</span><br><span class="line">            result = shardedJedisOperate.set(<span class="string">&quot;22-key&quot;</span>, <span class="string">&quot;22-value&quot;</span>);</span><br><span class="line">            result += <span class="string">&quot;999&quot;</span>;</span><br><span class="line">            LOGGER.info(<span class="string">&quot;result-1:&#123;&#125;&quot;</span>, result);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            LOGGER.error(e.getMessage(), e);</span><br><span class="line">        &#125;</span><br><span class="line">        LOGGER.info(<span class="string">&quot;....end-1....&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;, threadPoolExecutor);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//thenCompose</span></span><br><span class="line">    <span class="comment">//CompletableFuture&lt;String&gt; thenCompose = supplyAsync1.thenCompose(new Function&lt;String, CompletionStage&lt;String&gt;&gt;() &#123;</span></span><br><span class="line">    <span class="comment">//    @Override</span></span><br><span class="line">    <span class="comment">//    public CompletionStage&lt;String&gt; apply(String s) &#123;</span></span><br><span class="line">    <span class="comment">//        LOGGER.info(&quot;receive msg:&#123;&#125;&quot;, s);</span></span><br><span class="line">    <span class="comment">//        return CompletableFuture.supplyAsync(new Supplier&lt;String&gt;() &#123;</span></span><br><span class="line">    <span class="comment">//            @Override</span></span><br><span class="line">    <span class="comment">//            public String get() &#123;</span></span><br><span class="line">    <span class="comment">//                String result = StringUtils.EMPTY;</span></span><br><span class="line">    <span class="comment">//                try &#123;</span></span><br><span class="line">    <span class="comment">//                    TimeUnit.MILLISECONDS.sleep((long) (Math.random() * 1000));</span></span><br><span class="line">    <span class="comment">//                    result = shardedJedisOperate.set(&quot;23-key&quot;, &quot;23-value&quot;);</span></span><br><span class="line">    <span class="comment">//                    result += &quot;9852631--&quot;;</span></span><br><span class="line">    <span class="comment">//                    result += s;</span></span><br><span class="line">    <span class="comment">//                    LOGGER.info(&quot;result-2:&#123;&#125;&quot;, result);</span></span><br><span class="line">    <span class="comment">//                &#125; catch (Exception e) &#123;</span></span><br><span class="line">    <span class="comment">//                    LOGGER.error(e.getMessage(), e);</span></span><br><span class="line">    <span class="comment">//                &#125;</span></span><br><span class="line">    <span class="comment">//                LOGGER.info(&quot;....end-2....&quot;);</span></span><br><span class="line">    <span class="comment">//                return result;</span></span><br><span class="line">    <span class="comment">//            &#125;</span></span><br><span class="line">    <span class="comment">//        &#125;);</span></span><br><span class="line">    <span class="comment">//    &#125;</span></span><br><span class="line">    <span class="comment">//&#125;);</span></span><br><span class="line"></span><br><span class="line">    CompletableFuture&lt;String&gt; thenCompose = supplyAsync1.thenComposeAsync(<span class="keyword">new</span> <span class="title class_">Function</span>&lt;String, CompletionStage&lt;String&gt;&gt;() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> CompletionStage&lt;String&gt; <span class="title function_">apply</span><span class="params">(String s)</span> &#123;</span><br><span class="line">            LOGGER.info(<span class="string">&quot;receive msg:&#123;&#125;&quot;</span>, s);</span><br><span class="line">            <span class="keyword">return</span> CompletableFuture.supplyAsync(<span class="keyword">new</span> <span class="title class_">Supplier</span>&lt;String&gt;() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="keyword">public</span> String <span class="title function_">get</span><span class="params">()</span> &#123;</span><br><span class="line">                    <span class="type">String</span> <span class="variable">result</span> <span class="operator">=</span> StringUtils.EMPTY;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        TimeUnit.MILLISECONDS.sleep((<span class="type">long</span>) (Math.random() * <span class="number">1000</span>));</span><br><span class="line">                        result = shardedJedisOperate.set(<span class="string">&quot;23-key&quot;</span>, <span class="string">&quot;23-value&quot;</span>);</span><br><span class="line">                        result += <span class="string">&quot;9852631--&quot;</span>;</span><br><span class="line">                        result += s;</span><br><span class="line">                        LOGGER.info(<span class="string">&quot;result-2:&#123;&#125;&quot;</span>, result);</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                        LOGGER.error(e.getMessage(), e);</span><br><span class="line">                    &#125;</span><br><span class="line">                    LOGGER.info(<span class="string">&quot;....end-2....&quot;</span>);</span><br><span class="line">                    <span class="keyword">return</span> result;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//CompletableFuture&lt;String&gt; thenCompose = supplyAsync1.thenComposeAsync(new Function&lt;String, CompletionStage&lt;String&gt;&gt;() &#123;</span></span><br><span class="line">    <span class="comment">//    @Override</span></span><br><span class="line">    <span class="comment">//    public CompletionStage&lt;String&gt; apply(String s) &#123;</span></span><br><span class="line">    <span class="comment">//        LOGGER.info(&quot;receive msg:&#123;&#125;&quot;, s);</span></span><br><span class="line">    <span class="comment">//        return CompletableFuture.supplyAsync(new Supplier&lt;String&gt;() &#123;</span></span><br><span class="line">    <span class="comment">//            @Override</span></span><br><span class="line">    <span class="comment">//            public String get() &#123;</span></span><br><span class="line">    <span class="comment">//                String result = StringUtils.EMPTY;</span></span><br><span class="line">    <span class="comment">//                try &#123;</span></span><br><span class="line">    <span class="comment">//                    TimeUnit.MILLISECONDS.sleep((long) (Math.random() * 1000));</span></span><br><span class="line">    <span class="comment">//                    result = shardedJedisOperate.set(&quot;23-key&quot;, &quot;23-value&quot;);</span></span><br><span class="line">    <span class="comment">//                    result += &quot;9852631--&quot;;</span></span><br><span class="line">    <span class="comment">//                    result += s;</span></span><br><span class="line">    <span class="comment">//                    LOGGER.info(&quot;result-2:&#123;&#125;&quot;, result);</span></span><br><span class="line">    <span class="comment">//                &#125; catch (Exception e) &#123;</span></span><br><span class="line">    <span class="comment">//                    LOGGER.error(e.getMessage(), e);</span></span><br><span class="line">    <span class="comment">//                &#125;</span></span><br><span class="line">    <span class="comment">//                LOGGER.info(&quot;....end-2....&quot;);</span></span><br><span class="line">    <span class="comment">//                return result;</span></span><br><span class="line">    <span class="comment">//            &#125;</span></span><br><span class="line">    <span class="comment">//        &#125;);</span></span><br><span class="line">    <span class="comment">//    &#125;</span></span><br><span class="line">    <span class="comment">//&#125;, threadPoolExecutor);</span></span><br><span class="line"></span><br><span class="line">    <span class="type">String</span> <span class="variable">result</span> <span class="operator">=</span> thenCompose.get();</span><br><span class="line">    LOGGER.info(<span class="string">&quot;end result:&#123;&#125;&quot;</span>, result);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br><h2 id="allOf、anyOf">2.9. allOf、anyOf</h2><p>allOf：所有的CompletableFuture都执行完后执行计算</p><p>anyOf：任意一个CompletableFuture执行完后就会执行计算</p><br><h3 id="allOf">2.9.1. allOf</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">testAllOf</span><span class="params">()</span> <span class="keyword">throws</span> ExecutionException, InterruptedException &#123;</span><br><span class="line"></span><br><span class="line">    CompletableFuture&lt;String&gt; supplyAsync1 = CompletableFuture.supplyAsync(() -&gt; &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">result</span> <span class="operator">=</span> StringUtils.EMPTY;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            TimeUnit.MILLISECONDS.sleep((<span class="type">long</span>) (Math.random() * <span class="number">1500</span>));</span><br><span class="line">            result = shardedJedisOperate.set(<span class="string">&quot;22-key&quot;</span>, <span class="string">&quot;22-value&quot;</span>);</span><br><span class="line">            result += <span class="string">&quot;000&quot;</span>;</span><br><span class="line">            LOGGER.info(<span class="string">&quot;result-1:&#123;&#125;&quot;</span>, result);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            LOGGER.error(e.getMessage(), e);</span><br><span class="line">        &#125;</span><br><span class="line">        LOGGER.info(<span class="string">&quot;....end-1....&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;, threadPoolExecutor);</span><br><span class="line"></span><br><span class="line">    CompletableFuture&lt;String&gt; supplyAsync2 = CompletableFuture.supplyAsync(() -&gt; &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">result</span> <span class="operator">=</span> StringUtils.EMPTY;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            TimeUnit.MILLISECONDS.sleep((<span class="type">long</span>) (Math.random() * <span class="number">1000</span>));</span><br><span class="line">            result = shardedJedisOperate.set(<span class="string">&quot;23-key&quot;</span>, <span class="string">&quot;23-value&quot;</span>);</span><br><span class="line">            result += <span class="string">&quot;222&quot;</span>;</span><br><span class="line">            LOGGER.info(<span class="string">&quot;result-2:&#123;&#125;&quot;</span>, result);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            LOGGER.error(e.getMessage(), e);</span><br><span class="line">        &#125;</span><br><span class="line">        LOGGER.info(<span class="string">&quot;....end-2....&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;, threadPoolExecutor);</span><br><span class="line"></span><br><span class="line">    List&lt;CompletableFuture&lt;String&gt;&gt; futureList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;(Arrays.asList(supplyAsync1, supplyAsync2));</span><br><span class="line">    CompletableFuture&lt;List&lt;String&gt;&gt; completableFuture = allOf(futureList);</span><br><span class="line">    List&lt;String&gt; result = completableFuture.get();</span><br><span class="line">    LOGGER.info(<span class="string">&quot;end - result:&#123;&#125;&quot;</span>, result);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> &lt;T&gt; CompletableFuture&lt;List&lt;T&gt;&gt; <span class="title function_">allOf</span><span class="params">(List&lt;CompletableFuture&lt;T&gt;&gt; futuresList)</span> &#123;</span><br><span class="line">    CompletableFuture&lt;Void&gt; allFuturesResult = CompletableFuture</span><br><span class="line">            .allOf(futuresList.toArray(<span class="keyword">new</span> <span class="title class_">CompletableFuture</span>[futuresList.size()]));</span><br><span class="line">    <span class="keyword">return</span> allFuturesResult.thenApply(v -&gt;</span><br><span class="line">            futuresList.stream().map(CompletableFuture::join).collect(Collectors.&lt;T&gt;toList())</span><br><span class="line">    );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br><h3 id="anyOf">2.9.2. anyOf</h3><p>任意一个CompletableFuture执行完后就会执行计算</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">testAnyOf</span><span class="params">()</span> <span class="keyword">throws</span> ExecutionException, InterruptedException &#123;</span><br><span class="line">    CompletableFuture&lt;String&gt; supplyAsync1 = CompletableFuture.supplyAsync(() -&gt; &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">result</span> <span class="operator">=</span> StringUtils.EMPTY;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            TimeUnit.MILLISECONDS.sleep((<span class="type">long</span>) (Math.random() * <span class="number">3500</span>));</span><br><span class="line">            result = shardedJedisOperate.set(<span class="string">&quot;24-key&quot;</span>, <span class="string">&quot;24-value&quot;</span>);</span><br><span class="line">            result += <span class="string">&quot;000&quot;</span>;</span><br><span class="line">            LOGGER.info(<span class="string">&quot;result-1:&#123;&#125;&quot;</span>, result);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            LOGGER.error(e.getMessage(), e);</span><br><span class="line">        &#125;</span><br><span class="line">        LOGGER.info(<span class="string">&quot;....end-1....&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;, threadPoolExecutor);</span><br><span class="line"></span><br><span class="line">    CompletableFuture&lt;String&gt; supplyAsync2 = CompletableFuture.supplyAsync(() -&gt; &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">result</span> <span class="operator">=</span> StringUtils.EMPTY;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            TimeUnit.MILLISECONDS.sleep((<span class="type">long</span>) (Math.random() * <span class="number">1000</span>));</span><br><span class="line">            result = shardedJedisOperate.set(<span class="string">&quot;25-key&quot;</span>, <span class="string">&quot;25-value&quot;</span>);</span><br><span class="line">            result += <span class="string">&quot;222&quot;</span>;</span><br><span class="line">            LOGGER.info(<span class="string">&quot;result-2:&#123;&#125;&quot;</span>, result);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            LOGGER.error(e.getMessage(), e);</span><br><span class="line">        &#125;</span><br><span class="line">        LOGGER.info(<span class="string">&quot;....end-2....&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;, threadPoolExecutor);</span><br><span class="line"></span><br><span class="line">    CompletableFuture&lt;Object&gt; anyOfResult = CompletableFuture.anyOf(supplyAsync1, supplyAsync2);</span><br><span class="line">    <span class="type">Object</span> <span class="variable">result</span> <span class="operator">=</span> anyOfResult.get();</span><br><span class="line">    LOGGER.info(<span class="string">&quot;end result:&#123;&#125;&quot;</span>, result);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br><h1 id="使用示例">3. 使用示例</h1><p>项目中，需要查询页面的菜单和功能信息；为了提高性能，可以使用<code>CompletableFuture</code>并行查询。</p><p>虽然可以并行查询菜单和功能信息，但是接口逻辑同步的，需要等待菜单、功能信息全部查询完毕，才能返回结果数据。</p><p>因此，阻塞等待两个线程都完成了以后，再返回数据。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 获取 菜单、功能 信息</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> roleKey           角色key</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> roleMenuFeatureBO</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">getMenuAndFeatureInfo</span><span class="params">(String roleKey, RoleMenuFeatureBO roleMenuFeatureBO)</span> &#123;</span><br><span class="line">    <span class="comment">//查询菜单</span></span><br><span class="line">    CompletableFuture&lt;Map&lt;String, Object&gt;&gt; menusFuture = menuService.getMenuCompletableFuture(roleKey);</span><br><span class="line">    <span class="comment">//查询功能</span></span><br><span class="line">    CompletableFuture&lt;Map&lt;String, Object&gt;&gt; featuresFuture = featureService.getFeatureCompletableFuture(roleKey);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//阻塞,等待所有future完成,获取结果</span></span><br><span class="line">    Map&lt;String, Object&gt; collect = allOfGetMap(<span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;(Arrays.asList(menusFuture, featuresFuture)));</span><br><span class="line"></span><br><span class="line">    roleMenuFeatureBO.setMenus((List&lt;MenuBO&gt;) collect.get(MENUS_STR));</span><br><span class="line">    roleMenuFeatureBO.setFeatures((List&lt;FeatureBO&gt;) collect.get(FEATURES_STR));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> CompletableFuture&lt;Map&lt;String, Object&gt;&gt; <span class="title function_">getMenuCompletableFuture</span><span class="params">(String roleKey)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> CompletableFuture.supplyAsync(() -&gt; &#123;</span><br><span class="line">        Map&lt;String, Object&gt; datas = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        <span class="built_in">this</span>.queryByRoleKey(roleKey).ifPresent(menuBoS -&gt; &#123;</span><br><span class="line">            datas.put(MENUS_STR, menuBoS);</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="keyword">return</span> datas;</span><br><span class="line">    &#125;, toolThreadPool);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 等待future全部完成后,聚合所有future的返回值</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> * API：&#123;<span class="doctag">@link</span> CompletableFuture#allOf&#125;</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> * 使用场景：</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * &lt;blockquote&gt;</span></span><br><span class="line"><span class="comment"> * 多个任务,可以异步执行（没有业务关联），但是返回类型不同。&lt;br/&gt;</span></span><br><span class="line"><span class="comment"> * 在异步任务中包装Map,将相同类型的返回值使用一样的key，最后get后，根据Key进行强转</span></span><br><span class="line"><span class="comment"> * &lt;/blockquote&gt;</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> futuresList</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> map</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Map&lt;String, Object&gt; <span class="title function_">allOfGetMap</span><span class="params">(<span class="keyword">final</span> List&lt;CompletableFuture&lt;Map&lt;String, Object&gt;&gt;&gt; futuresList)</span> &#123;</span><br><span class="line">    CompletableFuture&lt;List&lt;Map&lt;String, Object&gt;&gt;&gt; resultFuture = allOf(futuresList);</span><br><span class="line">    List&lt;Map&lt;String, Object&gt;&gt; getResult = Collections.emptyList();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        getResult = resultFuture.get();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        log.error(e.getMessage(), e);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> toMap(getResult);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br><h1 id="Reference">4. Reference</h1><ul><li><a target="_blank" rel="noopener" href="https://www.cnblogs.com/jmcui/p/11335445.html">Java8 CompletableFuture 编程</a></li></ul><br><link rel="stylesheet" href="/css/folder.css" type="text/css"><script src="/js/folder.js" type="text/javascript" async></script><link rel="stylesheet" href="/css/spoiler.css" type="text/css"><script src="/js/spoiler.js" type="text/javascript" async></script></div></div><div id="btn-catalog" class="btn-catalog"><i class="iconfont icon-catalog"></i></div><div class="post-catalog hidden" id="catalog"><div class="title">目录</div><div class="catalog-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%99%AE%E9%80%9AFuture"><span class="toc-text">1. 普通Future</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#get-%E6%96%B9%E6%B3%95%E7%A4%BA%E4%BE%8B"><span class="toc-text">1.1. get() 方法示例</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#get-timeout-timeUnit-%E6%96%B9%E6%B3%95%E7%A4%BA%E4%BE%8B"><span class="toc-text">1.2. get(timeout, timeUnit) 方法示例</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B1%80%E9%99%90%E6%80%A7"><span class="toc-text">1.3. 局限性</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#CompletableFuture"><span class="toc-text">2. CompletableFuture</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#runAsync%E3%80%81supplyAsync"><span class="toc-text">2.1. runAsync、supplyAsync</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#runAsync"><span class="toc-text">2.1.1. runAsync</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#supplyAsync"><span class="toc-text">2.1.2. supplyAsync</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#whenComplete%E3%80%81exceptionally"><span class="toc-text">2.2. whenComplete、exceptionally</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#whenComplete"><span class="toc-text">2.2.1. whenComplete</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#whenCompleteAsync"><span class="toc-text">2.2.2. whenCompleteAsync</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#exceptionally"><span class="toc-text">2.2.3. exceptionally</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#thenApply%E3%80%81handle"><span class="toc-text">2.3. thenApply、handle</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#thenApply"><span class="toc-text">2.3.1. thenApply</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#handle"><span class="toc-text">2.3.2. handle</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#thenAccept%E3%80%81thenRun"><span class="toc-text">2.4. thenAccept、thenRun</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#thenAccept"><span class="toc-text">2.4.1. thenAccept</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#thenRun"><span class="toc-text">2.4.2. thenRun</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#thenCombine%E3%80%81thenAcceptBoth"><span class="toc-text">2.5. thenCombine、thenAcceptBoth</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#thenCombine"><span class="toc-text">2.5.1. thenCombine</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#thenAcceptBoth"><span class="toc-text">2.5.2. thenAcceptBoth</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#applyToEither-%E3%80%81acceptEither"><span class="toc-text">2.6. applyToEither 、acceptEither</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#applyToEither"><span class="toc-text">2.6.1. applyToEither</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#acceptEither"><span class="toc-text">2.6.2. acceptEither</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#runAfterEither-%E3%80%81runAfterBoth"><span class="toc-text">2.7. runAfterEither 、runAfterBoth</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#runAfterEither"><span class="toc-text">2.7.1. runAfterEither</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#runAfterBoth"><span class="toc-text">2.7.2. runAfterBoth</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#thenCompose"><span class="toc-text">2.8. thenCompose</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#allOf%E3%80%81anyOf"><span class="toc-text">2.9. allOf、anyOf</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#allOf"><span class="toc-text">2.9.1. allOf</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#anyOf"><span class="toc-text">2.9.2. anyOf</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E7%A4%BA%E4%BE%8B"><span class="toc-text">3. 使用示例</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Reference"><span class="toc-text">4. Reference</span></a></li></ol></div></div><script src="/js/catalog.js"></script><div class="comments-container"></div></div><div class="footer"><div class="social"><ul><li><a title="github" target="_blank" rel="noopener" href="https://github.com/Simba-cheng"><i class="iconfont icon-github"></i></a></li><li><a title="rss" href="/atom.xml"><i class="iconfont icon-rss"></i></a></li></ul></div><div class="footer-more"><a target="_blank" rel="noopener" href="https://github.com/zchengsite/hexo-theme-oranges">Copyright © 2025 Oranges</a></div><div class="footer-more"><a target="_blank" rel="noopener" href="https://github.com/zchengsite/hexo-theme-oranges">Theme by Oranges | Powered by Hexo</a></div><div class="footer-views">本站总访问量<span id="busuanzi_value_site_pv"></span>次 本文总阅读量<span id="busuanzi_value_page_pv"></span>次 本站访客数<span id="busuanzi_value_site_uv"></span>人</div></div></div><div class="tools-bar"><div class="back-to-top tools-bar-item hidden"><a href="javascript: void(0)"><i class="iconfont icon-chevronup"></i></a></div><script src="/js/backtotop.js"></script><div class="search-icon tools-bar-item" id="search-icon"><a href="javascript: void(0)"><i class="iconfont icon-search"></i></a></div><div class="search-overlay hidden"><div class="search-content" tabindex="0"><div class="search-title"><span class="search-icon-input"><a href="javascript: void(0)"><i class="iconfont icon-search"></i> </a></span><input type="text" class="search-input" id="search-input" placeholder="搜索..."> <span class="search-close-icon" id="search-close-icon"><a href="javascript: void(0)"><i class="iconfont icon-close"></i></a></span></div><div class="search-result" id="search-result"></div></div></div><script type="text/javascript">var inputArea=document.querySelector("#search-input"),searchOverlayArea=document.querySelector(".search-overlay");function openOrHideSearchContent(){searchOverlayArea.classList.contains("hidden")?(searchOverlayArea.classList.remove("hidden"),document.body.classList.add("hidden")):(searchOverlayArea.classList.add("hidden"),document.body.classList.remove("hidden"))}function blurSearchContent(e){e.target===searchOverlayArea&&openOrHideSearchContent()}inputArea.onclick=function(){getSearchFile(),this.onclick=null},inputArea.onkeydown=function(){if(13==event.keyCode)return!1},document.querySelector("#search-icon").addEventListener("click",openOrHideSearchContent,!1),document.querySelector("#search-close-icon").addEventListener("click",openOrHideSearchContent,!1),searchOverlayArea.addEventListener("click",blurSearchContent,!1);var searchFunc=function(e,t,n){"use strict";var r=document.getElementById(t),a=document.getElementById(n);a.innerHTML="<ul><span class='local-search-empty'>首次搜索，正在载入索引文件，请稍后……<span></ul>",$.ajax({url:e,dataType:"xml",success:function(e){var t=$("entry",e).map(function(){return{title:$("title",this).text(),content:$("content",this).text(),url:$("url",this).text()}}).get();a.innerHTML="",r.addEventListener("input",function(){var u='<ul class="search-result-list">',h=this.value.trim().toLowerCase().split(/[\s\-]+/);if(a.innerHTML="",!(this.value.trim().length<=0)){if(t.forEach(function(e){var n,r,a=!0,t=(e.title&&""!==e.title.trim()||(e.title="Untitled"),e.title.trim()),c=t.toLowerCase(),s=e.content.trim().replace(/<[^>]+>/g,""),i=s.toLowerCase(),e=e.url,l=-1,o=-1;""!==i?h.forEach(function(e,t){n=c.indexOf(e),l=i.indexOf(e),n<0&&l<0?a=!1:(l<0&&(l=0),0==t&&(o=l))}):a=!1,a&&(u+="<li><a href='"+e+"' class='search-result-title'>"+t+"</a>",0<=o&&(e=o+80,(e=0==(t=(t=o-20)<0?0:t)?100:e)>s.length&&(e=s.length),r=s.substr(t,e),h.forEach(function(e){var t=new RegExp(e,"gi");r=r.replace(t,'<span class="search-keyword">'+e+"</span>")}),u+='<p class="search-result-abstract">'+r+"...</p>"),u+="</li>")}),-1===(u+="</ul>").indexOf("<li>"))return a.innerHTML="<ul><span class='local-search-empty'>没有找到内容，请尝试更换检索词。<span></ul>";a.innerHTML=u}})},error:function(e,t,n){a.innerHTML="",404===e.status?a.innerHTML="<ul><span class='local-search-empty'>未找到search.xml文件，具体请参考：<a href='https://github.com/zchengsite/hexo-theme-oranges#configuration' target='_black'>configuration</a><span></ul>":a.innerHTML="<ul><span class='local-search-empty'>请求失败，尝试重新刷新页面或稍后重试。<span></ul>"}}),$(document).on("click","#search-close-icon",function(){$("#search-input").val(""),$("#search-result").html("")})},getSearchFile=function(){searchFunc("/search.xml","search-input","search-result")}</script><div class="tools-bar-item theme-icon" id="switch-color-scheme"><a href="javascript: void(0)"><i id="theme-icon" class="iconfont icon-moon"></i></a></div><script src="/js/colorscheme.js"></script><div class="share-icon tools-bar-item"><a href="javascript: void(0)" id="share-icon"><i class="iconfont iconshare"></i></a><div class="share-content hidden"><a class="share-item" href="https://twitter.com/intent/tweet?text=' + Future%20%E5%92%8C%20CompletableFuture + '&url=' + https%3A%2F%2Fsimba-cheng.github.io%2Fposts%2F5057.html + '" target="_blank" title="Twitter"><i class="iconfont icon-twitter"></i> </a><a class="share-item" href="https://www.facebook.com/sharer.php?u=https://simba-cheng.github.io/posts/5057.html" target="_blank" title="Facebook"><i class="iconfont icon-facebooksquare"></i></a></div></div><script src="/js/shares.js"></script></div></div><script src="https://fastly.jsdelivr.net/npm/hexo-tag-common@0.2.0/js/index.js"></script><style>[bg-lazy]{background-image:none!important;background-color:#eee!important}</style><script>window.imageLazyLoadSetting={isSPA:!1,preloadRatio:3,processImages:null}</script><script>window.addEventListener("load",function(){var t=/\.(gif|jpg|jpeg|tiff|png)$/i,r=/^data:image\/[a-z]+;base64,/;Array.prototype.slice.call(document.querySelectorAll("img[data-original]")).forEach(function(a){var e=a.parentNode;"A"===e.tagName&&(e.href.match(t)||e.href.match(r))&&(e.href=a.dataset.original)})})</script><script>!function(r){r.imageLazyLoadSetting.processImages=t;var e=r.imageLazyLoadSetting.isSPA,n=r.imageLazyLoadSetting.preloadRatio||1,c=a();function a(){var t=Array.prototype.slice.call(document.querySelectorAll("img[data-original]")),e=Array.prototype.slice.call(document.querySelectorAll("[bg-lazy]"));return t.concat(e)}function t(){e&&(c=a());for(var t,o=0;o<c.length;o++)0<=(t=(t=c[o]).getBoundingClientRect()).bottom&&0<=t.left&&t.top<=(r.innerHeight*n||document.documentElement.clientHeight*n)&&function(){var t,e,n,a=c[o],i=function(){c=c.filter(function(t){return a!==t}),r.imageLazyLoadSetting.onImageLoaded&&r.imageLazyLoadSetting.onImageLoaded(a)};(t=a).hasAttribute("bg-lazy")?(t.removeAttribute("bg-lazy"),i()):(e=new Image,n=t.getAttribute("data-original"),e.onload=function(){t.src=n,t.removeAttribute("data-original"),i()},t.src!==n&&(e.src=n))}()}function i(){clearTimeout(t.tId),t.tId=setTimeout(t,500)}t(),document.addEventListener("scroll",i),r.addEventListener("resize",i),r.addEventListener("orientationchange",i)}(this)</script><script src="/js/markmap.js"></script></body></html>